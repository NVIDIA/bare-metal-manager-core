[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true
REPO_ROOT = { script = ["echo ${REPO_ROOT}"] }

[tasks.book]
workspace = false
command = "find"
args = ["public"]
dependencies = [
	"book-compile",
]

[tasks.create-kind-cluster]
category = "Kind"
description = "Build KinD cluster"
workspace = false
command = "kind"
args = ["create", "cluster", "--config", "dev/kube/kind/cluster.yaml"]
cwd="${REPO_ROOT}"

[tasks.configure_kind]
category = "Kind"
workspace=false
description = "kubectl apply KinD configuration"
script='''
kubectl kustomize dev/kube/overlays/local | kubectl apply -f -
kubectl rollout status deploy/cert-manager -n cert-manager
kubectl rollout status deploy/cert-manager-webhook -n cert-manager
kubectl rollout status deploy/cert-manager-cainjector -n cert-manager
kubectl kustomize dev/kube/overlays/local/forge/resources/certs | kubectl apply -f -
kubectl wait certs/forge-vpc-cert --for condition=Ready -n forge-system
kubectl apply -f vpc/config/forge.yaml
'''
cwd="${REPO_ROOT}"

[tasks.kind]
category = "Kind"
description = "Build carbide container and upload to KinD cluster"
workspace=false
dependencies = [
  "create-kind-cluster",
  "carbide-container",
  "load-carbide-container",
  "build-vpc-container",
  "load-vpc-container",
  "configure_kind"
]
cwd="${REPO_ROOT}"

[tasks.carbide-container]
category = "Kind"
description = "Build the carbide container"
workspace = false
command = "docker"
args = ["build", "-t", "carbide:latest", "-f", "dev/deployment/Dockerfile", "."]
cwd="${REPO_ROOT}"

[tasks.build-x86-build-container]
category = "Kind"
description = "Build the x86 build container"
workspace = false
command = "docker"
args = ["build", "-t", "gitlab-master.nvidia.com:5005/nvmetal/carbide/build-container:latest", "-f", "dev/docker/Dockerfile.build-container", "."]


[tasks.build-arm-build-container]
category = "Kind"
description = "Build the ARM build container"
workspace = false
command = "docker"
args = ["build", "-t", "gitlab-master.nvidia.com:5005/nvmetal/carbide/arm64v8/build-container:latest", "-f", "dev/docker/Dockerfile.build-container-arm", "."]


[tasks.load-carbide-container]
category = "Kind"
description = "Push image to Kind"
workspace = false
command = "kind"
args = ["load", "docker-image", "carbide:latest", "--name", "forge-local"]

[tasks.runtime-container]
category = "Docker Compose"
description = "Build the runtime container base image for Carbide components"
workspace = false
command = "docker"
args = ["build", "-t", "carbide-runtime:latest", "."]
env = { "DOCKER_BUILDKIT" = "1" }

[tasks.fullstack-up]
category = "Docker Compose"
description = "Brings up a full Carbide stack"
workspace = false
command = "docker-compose"
args = ["up", "-d"]

[tasks.fullstack-down]
category = "Docker Compose"
description = "Brings down the full Carbide stack"
workspace = false
command = "docker-compose"
args = ["down", "-v"]

[tasks.fullstack-cert-renew]
category = "Docker Compose"
description = "Renews all the certificates in the containers and reloads the services"
workspace=false
dependencies = [
	"fullstack-terraform",
	"fullstack-refresh-postgresql",
]

[tasks.fullstack-terraform]
category = "Docker Compose"
description = "Re-runs terraform in the running environment"
workspace = false
command = "docker-compose"
args = ["run", "terraform", "apply", "-auto-approve"]

[tasks.fullstack-refresh-postgresql]
category = "Docker Compose"
description = "Reloads postgres in the running container"
workspace = false
command = "docker-compose"
args = ["exec", "postgresql", "kill", "-HUP", "1"]


[tasks.book-compile]
workspace = false
command = "mdbook"
args = ["build", "-d", "../public", "book"]

[tasks.attribution]
workspace = false
command = "cargo"
args = ["license", "--avoid-build-deps", "--avoid-dev-deps", "--json"]


## - VPC Related tasks
[tasks.update-vpc-submodule]
workspace = false
script = '''
mkdir -p tmp
git fetch ssh://git@gitlab-master.nvidia.com:12051/nvmetal/vpc.git main
git subtree pull --prefix vpc/ ssh://git@gitlab-master.nvidia.com:12051/nvmetal/vpc.git main --squash -m 'updated rust structs for vpc crds'
kustomize build vpc/config/crd/ -o tmp/
'''
cwd="${REPO_ROOT}"

[tasks.generate-rust-from-crd]
workspace = false
script = '''
kopium -Adf tmp/apiextensions.k8s.io_v1_customresourcedefinition_configurationresourcepools.networkfabric.vpc.forge.gitlab-master.nvidia.com.yaml > api/src/kube/vpc/configuration_resource_pool.rs
kopium -Adf tmp/apiextensions.k8s.io_v1_customresourcedefinition_leafs.networkfabric.vpc.forge.gitlab-master.nvidia.com.yaml > api/src/kube/vpc/leaf.rs
kopium -Adf tmp/apiextensions.k8s.io_v1_customresourcedefinition_managedresources.resource.vpc.forge.gitlab-master.nvidia.com.yaml > api/src/kube/vpc/managed_resource.rs
kopium -Adf tmp/apiextensions.k8s.io_v1_customresourcedefinition_resourcegroups.resource.vpc.forge.gitlab-master.nvidia.com.yaml > api/src/kube/vpc/resource_group.rs
'''
cwd="${REPO_ROOT}"

[tasks.update-kube-structs]
workspace = false
dependencies = [
  "update-vpc-submodule",
  "generate-rust-from-crd",
]

[tasks.prep-build-vpc]
workspace = false
script = '''
mkdir -p vpc/bin
GOBIN=`pwd`/vpc/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.4.1
GOBIN=`pwd`/vpc/bin go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
GOBIN=`pwd`/vpc/bin go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2
GOBIN=`pwd`/vpc/bin go install sigs.k8s.io/kustomize/kustomize/v4@v4.5.5
'''
cwd="${REPO_ROOT}"

[tasks.build-vpc-container]
workspace = false
command = "make"
args = ["docker-build"]
cwd = "${REPO_ROOT}/vpc"
dependencies = [
  "prep-build-vpc"
]

[tasks.load-vpc-container]
category = "Kind"
description = "Push image to Kind"
workspace = false
command = "kind"
args = ["load", "docker-image", "quay.io/nvidia/forge-connectivity", "--name", "forge-local"]


