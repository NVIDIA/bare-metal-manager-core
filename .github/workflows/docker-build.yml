name: Build Container with Buildx

on:
  workflow_call:
    inputs:
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: true
        type: string
      context_path:
        description: 'Build context path'
        required: false
        default: '.'
        type: string
      build_args:
        description: 'Build arguments in JSON format'
        required: false
        type: string
        default: '{}'
      image_name:
        description: 'Image name without registry prefix'
        required: true
        type: string
      image_tag:
        description: 'Image tag'
        required: true
        type: string
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        default: 'linux/amd64'
        type: string
      runner:
        description: 'Runner label to use'
        required: false
        default: 'linux-amd64-cpu4'
        type: string
      push:
        description: 'Push image to registry'
        required: false
        default: false
        type: boolean
      load:
        description: 'Load image to local Docker daemon'
        required: false
        default: true
        type: boolean 
    secrets:
      NVCR_USERNAME:
        description: "NVIDIA Container Registry username (typically '$oauthtoken')"
        required: false
      NVCR_TOKEN:
        description: "NVIDIA Container Registry API token"
        required: false
    outputs:
      image_digest:
        description: 'Image digest'
        value: ${{ jobs.build.outputs.digest }}
      image_tag:
        description: 'Image tag used'
        value: ${{ jobs.build.outputs.image_tag }}

jobs:
  build:
    runs-on: ${{ inputs.runner }}
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      image_tag: ${{ inputs.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: inputs.push
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config: /etc/buildkit/buildkitd.toml

      - name: Login to NVCR
        if: inputs.push
        uses: ./.github/actions/docker-auth
        with:
          username: ${{ secrets.NVCR_USERNAME }}
          token: ${{ secrets.NVCR_TOKEN }}

      - name: Parse build arguments
        id: parse-args
        run: |
          BUILD_ARGS='${{ inputs.build_args }}'

          # Convert JSON to docker build-arg format
          if [ "${BUILD_ARGS}" != "{}" ] && [ -n "${BUILD_ARGS}" ]; then
            echo "build_args<<EOF" >> $GITHUB_OUTPUT
            echo "${BUILD_ARGS}" | jq -r 'to_entries | .[] | "--build-arg \(.key)=\(.value)"' | tr '\n' ' ' >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "build_args=" >> $GITHUB_OUTPUT
          fi

      - name: Build and optionally push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context_path }}
          file: ${{ inputs.dockerfile_path }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          load: ${{ inputs.load && !inputs.push }}
          tags: |
            "${{ inputs.image_name }}:${{ inputs.image_tag }}"
            "${{ inputs.image_name }}:latest"
          build-args: ${{ steps.parse-args.outputs.build_args }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display build summary
        run: |
          echo "âœ… Build completed successfully"
          echo "  Image: ${{ steps.compute-image.outputs.full_image }}"
          echo "  Digest: ${{ steps.build.outputs.digest }}"
          echo "  Platforms: ${{ inputs.platforms }}"
          echo "  Pushed: ${{ inputs.push }}"
          echo "  Loaded locally: ${{ inputs.load && !inputs.push }}"

