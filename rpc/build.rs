/*
 * SPDX-FileCopyrightText: Copyright (c) 2021-2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
 * SPDX-License-Identifier: LicenseRef-NvidiaProprietary
 *
 * NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
 * property and proprietary rights in and to this material, related
 * documentation and any modifications thereto. Any use, reproduction,
 * disclosure or distribution of this material and related documentation
 * without an express license agreement from NVIDIA CORPORATION or
 * its affiliates is strictly prohibited.
 */
use heck::{ToSnakeCase, ToUpperCamelCase};
use lazy_static::lazy_static;
use quote::__private::TokenStream;
use quote::{TokenStreamExt, quote};
use std::collections::HashMap;
use std::path::{Path, PathBuf};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    let out_dir = PathBuf::from(std::env::var_os("OUT_DIR").unwrap());
    let autogenerated_rust_output_directory = PathBuf::from("src/protos");
    // The reflection path is part of the output directory (which might be debug or release),
    // so that different builds get a different binary file and concurrent builds don't collide
    let reflection = out_dir.join("forge.bin");

    tonic_build::configure()
        .file_descriptor_set_path(reflection)
        .type_attribute(
            ".google.protobuf.Timestamp",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .extern_path(".google.protobuf.Duration", "crate::Duration")
        .extern_path(".google.protobuf.Timestamp", "crate::Timestamp")
        .include_file("prost_common.rs")
        .type_attribute(".health", "#[derive(serde::Serialize)]")
        .type_attribute(
            ".machine_discovery",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            ".site_explorer",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.AdminForceDeleteMachineRequest",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.AdminForceDeleteMachineResponse",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.CredentialResponse", "#[derive(serde::Serialize)]")
        .type_attribute("forge.Domain", "#[derive(serde::Serialize)]")
        .type_attribute("forge.DomainList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.FlatInterfaceConfig", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.InstanceInterfaceConfig",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.InstanceInterfaceConfig.network_details",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.InstanceIBInterfaceConfig",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.InstanceUpdateStatus", "#[derive(serde::Serialize)]")
        .type_attribute("forge.InstanceNetworkConfig", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.InstanceInfinibandConfig",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.InstanceStorageConfig", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantConfig", "#[derive(serde::Serialize)]")
        .type_attribute("forge.InstanceConfig", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.InstanceInterfaceStatus",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.InstanceIBInterfaceStatus",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.InstanceNetworkStatus", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.InstanceInfinibandStatus",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.InstanceStorageStatus", "#[derive(serde::Serialize)]")
        .type_attribute("forge.InstanceTenantStatus", "#[derive(serde::Serialize)]")
        .type_attribute("forge.InstanceStatus", "#[derive(serde::Serialize)]")
        .type_attribute("forge.Instance", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.Metadata",
            "#[derive(serde::Serialize, serde::Deserialize, Eq)]",
        )
        .type_attribute(
            "forge.Label",
            "#[derive(serde::Serialize, serde::Deserialize, Eq)]",
        )
        .type_attribute(
            "forge.InstancePhoneHomeLastContactRequest",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.InstancePhoneHomeLastContactResponse",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.InstanceList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.Machine", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.MachineCapabilitiesSet",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesCpu",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesGpu",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesMemory",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesStorage",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesNetwork",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesInfiniband",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineCapabilityAttributesDpu",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.MachineList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.MachineEvent", "#[derive(serde::Serialize)]")
        .type_attribute("forge.MachineInterface", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.InfinibandStatusObservation",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.MachineIbInterface", "#[derive(serde::Serialize)]")
        .type_attribute("forge.MachineState", "#[derive(serde::Serialize)]")
        .type_attribute("forge.MachineArchitecture", "#[derive(serde::Serialize)]")
        .type_attribute("forge.MachineInventory", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.MachineInventorySoftwareComponent",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.HealthReportOverride", "#[derive(serde::Serialize)]")
        .type_attribute("forge.HealthOverrideOrigin", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.ManagedHostNetworkConfig",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.ManagedHostNetworkConfigResponse",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.NetworkPrefix", "#[derive(serde::Serialize)]")
        .type_attribute("forge.NetworkPrefixEvent", "#[derive(serde::Serialize)]")
        .type_attribute("forge.NetworkSegment", "#[derive(serde::Serialize)]")
        .type_attribute("forge.IBPartitionConfig", "#[derive(serde::Serialize)]")
        .type_attribute("forge.IBPartitionStatus", "#[derive(serde::Serialize)]")
        .type_attribute("forge.IBPartition", "#[derive(serde::Serialize)]")
        .type_attribute("forge.IBPartitionList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.IpxeOperatingSystem", "#[derive(serde::Serialize)]")
        .type_attribute("forge.NetworkSegmentList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.OperatingSystem", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.OperatingSystem.variant",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.InterfaceList", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.NetworkSegmentStateHistory",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.Tenant", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantContent", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantKeyset", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantKeysetContent", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantKeysetList", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.TenantKeysetIdentifier",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.TenantPublicKey", "#[derive(serde::Serialize)]")
        .type_attribute("forge.TenantKeySetList", "#[derive(serde::Serialize)]")
        .type_attribute("forge.VpcResourceState", "#[derive(serde::Serialize)]")
        .type_attribute("forge.MachineBootOverride", "#[derive(serde::Serialize)]")
        .type_attribute("forge.ConnectedDevice", "#[derive(serde::Serialize)]")
        .type_attribute("forge.NetworkDevice", "#[derive(serde::Serialize)]")
        .type_attribute("forge.NetworkTopologyData", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.InstanceInterfaceStatusObservation",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.FabricInterfaceData", "#[derive(serde::Serialize)]")
        .type_attribute("forge.LinkData", "#[derive(serde::Serialize)]")
        .type_attribute("forge.DpuNetworkStatus", "#[derive(serde::Serialize)]")
        .type_attribute("forge.LastDhcpRequest", "#[derive(serde::Serialize)]")
        .type_attribute("forge.ResourcePool", "#[derive(serde::Serialize)]")
        .type_attribute("forge.Vpc", "#[derive(serde::Serialize)]")
        .type_attribute("forge.VpcList", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.StorageClusterAttributes",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.VpcPrefix", "#[derive(serde::Serialize)]")
        .type_attribute("forge.StorageCluster", "#[derive(serde::Serialize)]")
        .type_attribute("forge.StoragePoolAttributes", "#[derive(serde::Serialize)]")
        .type_attribute("forge.StoragePool", "#[derive(serde::Serialize)]")
        .type_attribute("forge.StorageVolumeStatus", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.StorageVolumeAttributes",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.StorageVolume", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.DeleteStoragePoolRequest",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.ListStoragePoolRequest",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.ListStoragePoolResponse",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.DeleteStorageVolumeRequest",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.ListStorageVolumeRequest",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "forge.ListStorageVolumeResponse",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute("forge.OsImageAttributes", "#[derive(serde::Serialize)]")
        .type_attribute("forge.OsImage", "#[derive(serde::Serialize)]")
        .type_attribute("forge.ListOsImageRequest", "#[derive(serde::Serialize)]")
        .type_attribute("forge.ListOsImageResponse", "#[derive(serde::Serialize)]")
        .type_attribute("DeleteOsImageRequest", "#[derive(serde::Serialize)]")
        .type_attribute(
            "forge.MachineDiscoveryInfo",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "common.UUID",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.MachineDiscoveryInfo.discovery_data",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.DhcpDiscovery",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.UserRoles",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.BMCRequestType",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "forge.BmcInfo",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "forge.bmc_meta_data_update_request.DataItem",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "DataItem",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "bmc_meta_data_update_request",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "BMCMetaDataUpdateRequest",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "ControllerStateReason",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "RuntimeConfig",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute("StateSla", "#[derive(serde::Serialize)]")
        .type_attribute(
            "BuildInfo",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute("MachineValidationResultList", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationResult", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationRunList", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationRun", "#[derive(serde::Serialize)]")
        .type_attribute("ExpectedMachine", "#[derive(serde::Serialize)]")
        .type_attribute("ExpectedMachineList", "#[derive(serde::Serialize)]")
        .type_attribute(
            "TpmCaCertDetail",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "TpmCaCertDetailCollection",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "TpmEkCertStatus",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "TpmEkCertStatusCollection",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "TpmCaAddedCaStatus",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "TpmCaCertId",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute("MachineValidationState", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationCompleted", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationInProgress", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationStarted", "#[derive(serde::Serialize)]")
        .type_attribute("MachineValidationStatus", "#[derive(serde::Serialize)]")
        .type_attribute(
            "MachineValidationExternalConfig",
            "#[derive(serde::Serialize)]",
        )
        .type_attribute(
            "MachineValidationTestUpdateRequest",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "MachineValidationTestAddRequest",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "MachineValidationTest",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "MachineValidationTestsGetRequest",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "MachineValidationTestUpdateRequest.Payload",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.RedfishBrowseResponse",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroup",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupStatus",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupSource",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleDirection",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleProtocol",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleAction",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupAttributes",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleAttributes",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .field_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.direction",
            "#[serde(deserialize_with = \"NetworkSecurityGroupRuleDirection::from_string\", serialize_with = \"NetworkSecurityGroupRuleDirection::serialize_from_enum_i32\")]",
        )
        .field_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.protocol",
            "#[serde(deserialize_with = \"NetworkSecurityGroupRuleProtocol::from_string\", serialize_with = \"NetworkSecurityGroupRuleProtocol::serialize_from_enum_i32\")]",
        )
        .field_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.action",
            "#[serde(deserialize_with = \"NetworkSecurityGroupRuleAction::from_string\", serialize_with = \"NetworkSecurityGroupRuleAction::serialize_from_enum_i32\")]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.source_net",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.source_net",
            "#[serde(rename_all=\"snake_case\")]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.destination_net",
            "#[derive(serde::Deserialize,serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupRuleAttributes.destination_net",
            "#[serde(rename_all=\"snake_case\")]",
        )
        .type_attribute(
            "forge.InstanceNetworkRestrictions",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.FlatInterfaceNetworkSecurityGroupConfig",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.ResolvedNetworkSecurityGroupRule",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupAttachments",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute(
            "forge.NetworkSecurityGroupPropagationObjectStatus",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .type_attribute("Sku", "#[derive(serde::Serialize, serde::Deserialize)]")
        .type_attribute("SkuList", "#[derive(serde::Serialize, serde::Deserialize)]")
        .type_attribute(
            "SkuComponents",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentChassis",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentCpu",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentGpu",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentMemory",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentInfinibandDevices",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentEthernetDevices",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentStorage",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "SkuComponentTpm",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute("SkuId", "#[derive(serde::Serialize, serde::Deserialize)]")
        .type_attribute(
            "SkuStatus",
            "#[derive(serde::Serialize, serde::Deserialize)]",
        )
        .type_attribute(
            "forge.MachineHardwareInfoGpu",
            "#[derive(serde::Deserialize, serde::Serialize)]",
        )
        .build_server(true)
        .build_client(true)
        .protoc_arg("--experimental_allow_proto3_optional")
        .out_dir(autogenerated_rust_output_directory)
        .compile_protos(
            &[
                "proto/common.proto",
                "proto/forge.proto",
                "proto/machine_discovery.proto",
                "proto/site_explorer.proto",
            ],
            &["proto"],
        )
        .unwrap();

    write_api_client_wrapper_methods("src/protos/forge_api_client.rs");

    Ok(())
}

/// Write a set of helper methods as an `impl ForgeApiClient` block. See
/// [`make_forge_api_client_wrapper`] for details on what the wrapper methods do.
fn write_api_client_wrapper_methods<P: AsRef<Path>>(out: P) {
    let forge_fds = tonic_build::Config::new()
        .protoc_arg("--experimental_allow_proto3_optional")
        .load_fds(&["proto/forge.proto"], &["proto"])
        .unwrap()
        .file;

    let mut wrapper_methods = TokenStream::new();
    forge_fds
        .into_iter()
        .flat_map(|fd| fd.service)
        .flat_map(|svc| svc.method)
        .filter_map(make_forge_api_client_wrapper)
        .for_each(|m| wrapper_methods.append_all(m));

    let file = quote! {
        // GENERATED CODE: See `write_api_client_wrapper_methods` in `build.rs` at the root of this crate.
        // Extend ForgeApiClient by adding wrapper methods to every gRPC method in the forge namespace.
        impl crate::forge_api_client::ForgeApiClient {
            #wrapper_methods
        }
    };

    let ast: syn::File = syn::parse2(file).expect("not a valid tokenstream");
    let code = prettyplease::unparse(&ast);
    std::fs::write(out, code).expect("could not write output file");
}

/// Converts the given protobuf method descriptor into a method that looks like:
///
/// ```
/// pub async fn version(
///     &self,
///     request: crate::protos::forge::VersionRequest,
/// ) -> Result<crate::protos::forge::BuildInfo, tonic::Status> {
///     Ok(
///         self
///             .connection()
///             .await?
///             .version(tonic::Request::new(request))
///             .await?
///             .into_inner(),
///     )
/// }
/// ```
///
/// That is, it will wrap a `ForgeClientT` method, by:
///
/// - calling `self.connection().await?` to ensure the connection is initialized
/// - wrapping the request in `tonic::Request::new()`
/// - unpacking the response via `.into_inner()`
fn make_forge_api_client_wrapper(
    method: prost_types::MethodDescriptorProto,
) -> Option<TokenStream> {
    let method_name: TokenStream = method
        .name?
        .replace(".", "::")
        .to_snake_case()
        .parse::<TokenStream>()
        .unwrap();
    let input_type_str = convert_protobuf_type_to_rust_type(method.input_type?.as_str())?;
    let input_type: TokenStream = input_type_str.parse().unwrap();
    let output_type: TokenStream =
        convert_protobuf_type_to_rust_type(method.output_type?.as_str())?
            .parse()
            .unwrap();
    let token_stream = if input_type_str == "()" {
        // Don't make callers pass `()` to the method...
        quote! {
            pub async fn #method_name(&self) -> Result<#output_type, tonic::Status> {
                Ok(self
                    .connection()
                    .await?
                    .#method_name(tonic::Request::new(()))
                    .await?
                    .into_inner())
            }
        }
    } else {
        quote! {
            pub async fn #method_name(&self, request: #input_type) -> Result<#output_type, tonic::Status> {
                Ok(self
                    .connection()
                    .await?
                    .#method_name(tonic::Request::new(request))
                    .await?
                    .into_inner())
            }
        }
    };

    Some(token_stream)
}

/// Convert tye protobuf type (which looks like `.forge.VersionRequest` or similar) to the proper
/// rust type, by:
///
/// - Converting it to a known base type (bool, (), etc) if it's a known base type
///
/// or:
///
/// - Stripping the leading `.`
/// - Converting all but the last dot-separated components into snake_case
/// - Converting the last dot-separated component into CamelCase
/// - Joining the components with `::` instead of `.`
/// - Prefixing the type with `crate::protos::`, since that's the fully qualified path.
fn convert_protobuf_type_to_rust_type(t: &str) -> Option<String> {
    if let Some(base_type) = base_types.get(t) {
        return Some(base_type.clone());
    }

    let components = t.strip_prefix(".")?.split('.').collect::<Vec<_>>();
    let result = if components.len() > 1 {
        let leading = components[0..components.len() - 1]
            .iter()
            .map(|s| s.to_snake_case())
            .collect::<Vec<_>>()
            .join("::");
        let last = components[components.len() - 1].to_upper_camel_case();
        [leading, last].join("::")
    } else {
        components.last()?.to_upper_camel_case()
    };

    Some(format!("crate::protos::{result}"))
}

lazy_static! {
    /// Hardcoded list of types that correspond to rust primitives. Taken from [prost-build][0]
    ///
    /// [0]: https://github.com/tokio-rs/prost/blob/9f5a38101afaeda951e563b4721f812cd0918214/prost-build/src/extern_paths.rs#L26
    static ref base_types: HashMap<String, String> = HashMap::from([
        (".google.protobuf.BoolValue".to_string(), "bool".to_string()),
        (
            ".google.protobuf.BytesValue".to_string(),
            "::prost::alloc::vec::Vec<u8>".to_string(),
        ),
        (
            ".google.protobuf.DoubleValue".to_string(),
            "f64".to_string(),
        ),
        (".google.protobuf.Empty".to_string(), "()".to_string()),
        (".google.protobuf.FloatValue".to_string(), "f32".to_string()),
        (".google.protobuf.Int32Value".to_string(), "i32".to_string()),
        (".google.protobuf.Int64Value".to_string(), "i64".to_string()),
        (
            ".google.protobuf.StringValue".to_string(),
            "::prost::alloc::string::String".to_string(),
        ),
        (
            ".google.protobuf.UInt32Value".to_string(),
            "u32".to_string(),
        ),
        (
            ".google.protobuf.UInt64Value".to_string(),
            "u64".to_string(),
        ),
    ]);
}
