variables:
  NSPECT_ID: NSPECT-2SV4-7361
  APPLICATION_NAME: nvmetal-carbide
  APPLICATION_DOCKERFILE: dev/deployment/Dockerfile
  KUSTOMIZE_LOCATION: dev/kube

  FF_USE_FASTZIP: "true" # enable fastzip - a faster zip implementation that also supports level configuration.
  ARTIFACT_COMPRESSION_LEVEL: default # can also be set to fastest, fast, slow and slowest. If just enabling fastzip is not enough try setting this to fastest or fast.
  CACHE_COMPRESSION_LEVEL: fastest
  TRANSFER_METER_FREQUENCY: 5s

  KANIKO_CACHE_ARGS: "--cache=false --cache-copy-layers=true --cache-ttl=24h"
  APT_CACHE_DIR: $CI_PROJECT_DIR/apt
  LOGNAME: root
  KEA_BIN_PATH: /usr/bin
  KEA_INCLUDE_PATH: /usr/include/kea

  CARGO_MAKE_SKIP_CODECOV: "true"
  CARGO_INCREMENTAL: 0
  CARGO_HOME: $CI_PROJECT_DIR/cargo

include:
  - project: 'nvmetal/gitlab-templates'
    ref: main
    file:
      - defaults.gitlab-ci.yml

build-container:
  variables:
    DOCKER_FILE_LOCATION: $CI_PROJECT_DIR/dev/docker
    DOCKER_FILE: Dockerfile.build-container

build-container-arm:
  stage: .pre
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script: |
    mkdir -p /kaniko/.docker
    echo "$DOCKER_AUTH_CONFIG" > /kaniko/.docker/config.json
  script: |
    set -xeuo pipefail

    /kaniko/executor --context $CI_PROJECT_DIR/dev/docker --dockerfile $CI_PROJECT_DIR/dev/docker/Dockerfile.build-container-arm --destination urm.nvidia.com/swngc-ngcc-docker-local/forge/carbide/arm64v8/build-container:$VERSION
  needs: 
    - prepare-ci
  tags:
    - aarch64

build-cargo:
  stage: build
  script:
    - /etc/init.d/postgresql start
    - cargo make kind
    - cargo make workspace-ci-flow
  after_script:
    - kind delete cluster --name ${CI_PIPELINE_ID}
    - find target/debug/deps/ target/debug/.fingerprint/ -maxdepth 1 -mindepth 1 \( -type d  -name "rpc-*" -or -name "dhcp-*" -or -name "pxe-*" -or -name "dhcp-*" -or -name "dns-*" -or -name "cli-*" -or -name "ipmi-*" -or -name "vpc-*" \) -print0 | xargs -r0t rm -rf
    - find target/debug -maxdepth 1 -type f -delete
  cache:
    key: cargo-crate-cache
    paths:
      - cargo/
      - target/

build-ipxe-x86_64:
  before_script:
  - mkdir ~/.jfrog
  - echo "${JFROG_CONFIG}" > ~/.jfrog/jfrog-cli.conf.v5
  stage: build
  script:
    - cargo make --cwd pxe build-boot-artifacts-x86_64-ci
  when: manual 

build-ipxe-aarch64:
  before_script:
  - mkdir ~/.jfrog
  - echo "${JFROG_CONFIG}" > ~/.jfrog/jfrog-cli.conf.v5
  stage: build
  image: 
    name: urm.nvidia.com/swngc-ngcc-docker-local/forge/carbide/arm64v8/build-container:$VERSION
  script:
    - cargo make --cwd pxe build-boot-artifacts-aarch64-ci
  tags:
    - aarch64
  when: manual

checkmarx-scan-csv:
  before_script: |
    set -e
    /app/check_variables.sh gitlab
    rm -f pxe/mkosi.extra/etc/systemd/system/multi-user.target.wants/carbide-discovery.service

pages:
  stage: doc
  script:
    - cargo make book
  artifacts:
    paths:
      - public
  only:
    - trunk

deploy_dev1:
  extends: .deploy_kustomize
  environment: 
    name: dev1
    deployment_tier: development

deploy_dev2:
  extends: .deploy_kustomize
  needs: 
    - prepare-ci
    - deploy_dev1
  environment: 
    name: dev2
    deployment_tier: staging
