# Machine Lifecycle Testing

This aims to automate the "QC a build" process for testing machine ingestion.

The main file is [machine_lifecycle_test.py](machine_lifecycle_test.py).
Overall machine lifecycle test flow/logic:

- Check machine is Ready and not in maintenance mode
  - if it doesn't meet both conditions, immediately fail
- Force delete machine
- Reset DPU for discovery
- Wait for state `Host/WaitingForDiscovery`
- Power off host, sleep 60, power on host
- Wait for state `Ready`
- Create an instance
- SSH to instance for confirmation
- Delete instance
- Wait for state `Ready` (may take 1hr 20mins if DPU firmware upgrade happens)
  - The machine may get to state ready but then enter maintenance mode and goes through
    Reprovisioning/FW upgrade states, wait for exit maintenance mode.
- Confirm instance deleted

If the discovery portion fails at any point, put the machine into maintenance mode
for investigation.
This will prevent future pipeline runs from affecting it.


# How it works
The GitLab CI job `scheduled-test:machine-lifecycle-test` runs this test using a docker
image built during the job `build-machine-lifecycle-test-container`.
This container is x86 only since it is only used in CI.


# Updating Dependencies

Install [poetry](https://python-poetry.org/) if you don't have it:
```shell
curl -sSL https://install.python-poetry.org | python3 -
```
Add it to your path per the instructions in the output if necessary.
Documentation is [here](https://python-poetry.org/docs/).

Manage your dependencies/virtual environment with `poetry add` etc.
Dependencies are defined in [pyproject.toml](pyproject.toml) under
`[tool.poetry.dependencies]`.

If editing the file directly, remember to lock with `poetry lock`, which updates
[poetry.lock](poetry.lock).

To avoid putting poetry in the docker image for CI, we are using a
[requirements.txt](requirements.txt) file generated by poetry.

This needs manually updated whenever dependencies are changed. To do so, run:
```shell
poetry export --output requirements.txt
```
