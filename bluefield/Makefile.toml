# SPDX-FileCopyrightText: Copyright (c) 2021-2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-NvidiaProprietary
#
# NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
# property and proprietary rights in and to this material, related
# documentation and any modifications thereto. Any use, reproduction,
# disclosure or distribution of this material and related documentation
# without an express license agreement from NVIDIA CORPORATION or
# its affiliates is strictly prohibited.
[tasks.build-dpu-agent]
category = "Build"
description = "cross compile forge-dpu-agent locally"
workspace = false
script = '''
cross build --bin forge-dpu-agent --target aarch64-unknown-linux-gnu
'''
dependencies = [
    { name = "check-cross-installed", path = "${REPO_ROOT}" },
    { name = "build-cross-docker-image", path = "${REPO_ROOT}" },
]

[tasks.build-dpu-agent-ci]
category = "Build"
workspace = false
description = "Referring to the prebuilt 'build' task doesn't work here, since it always tries to build the full workspace - including targets that are not aarch64 compatible"
command = "cargo"
args = ["build", "--bin", "forge-dpu-agent"]

[tasks.setup-forge-dpu-deb]
category = "Build"
workspace = false
script = '''
    vers=$(grep Version misc/DEBIAN/control | cut -d : -f 2 | sed s/\ //g) && \
    export vers && \
    mkdir -p "forge-dpu_${vers}/lib/systemd/system" && \
    mkdir -p "forge-dpu_${vers}/usr/bin" && \
    cp ${REPO_ROOT}/target/debug/forge-dpu-agent "forge-dpu_${vers}/usr/bin/" && \
    cp misc/forge-dpu-agent.service "forge-dpu_${vers}/lib/systemd/system/" && \
    cp misc/local_bmc_dev "forge-dpu_${vers}/usr/bin/" && \
    cp misc/local_bmc_dev.service "forge-dpu_${vers}/lib/systemd/system/" && \
    cp -r misc/DEBIAN "forge-dpu_${vers}/"
'''
dependencies = [
    "build-dpu-agent",
]

[tasks.setup-forge-dpu-deb-ci]
category = "Build"
workspace = false
script = '''
    vers=$(grep Version misc/DEBIAN/control | cut -d : -f 2 | sed s/\ //g) && \
    export vers && \
    mkdir -p "forge-dpu_${vers}/lib/systemd/system" && \
    mkdir -p "forge-dpu_${vers}/usr/bin" && \
    cp ${REPO_ROOT}/target/debug/forge-dpu-agent "forge-dpu_${vers}/usr/bin/" && \
    cp misc/forge-dpu-agent.service "forge-dpu_${vers}/lib/systemd/system/" && \
    cp misc/local_bmc_dev "forge-dpu_${vers}/usr/bin/" && \
    cp misc/local_bmc_dev.service "forge-dpu_${vers}/lib/systemd/system/" && \
    cp -r misc/DEBIAN "forge-dpu_${vers}/"
'''
dependencies = [
    "build-dpu-agent-ci",
]

[tasks.build-forge-dpu-deb]
category = "Build"
description = "Build the forge-dpu.deb package"
workspace = false
script = '''
    vers=$(grep Version misc/DEBIAN/control | cut -d : -f 2 | sed s/\ //g) && \
    export vers && \
    dpkg-deb --build forge-dpu_${vers}
'''
dependencies = [
    "setup-forge-dpu-deb"
]

[tasks.build-forge-dpu-deb-ci]
category = "Build"
description = "Build the forge-dpu.deb package"
workspace = false
script = '''
    vers=$(grep Version misc/DEBIAN/control | cut -d : -f 2 | sed s/\ //g) && \
    export vers && \
    dpkg-deb --build forge-dpu_${vers}
'''
dependencies = [
    "setup-forge-dpu-deb-ci"
]
