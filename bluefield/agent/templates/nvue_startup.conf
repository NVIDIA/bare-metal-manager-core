- header:
    model: VX
    nvue-api-version: nvue_v1
    rev-id: 1.0
    version: Cumulus Linux 5.6.0
- set:
    bridge:
      domain:
        br_default:
          vlan:
{{- range .ComputeTENANTs }}
{{- range .PortConfigs }}
            '{{ .VlanID }}':
{{- if .L2VNI }}
              vni:
                '{{ .L2VNI }}': {}
{{- end }}
{{- end }}
{{- end }}
    evpn:
      enable: on
    interface:
      lo:
        ip:
          address:
            {{ .LoopbackIP }}/32: {}
        type: loopback
{{- range .Uplinks}}
      {{ . }}:
        type: swp
{{- end }}
{{- range .ComputeTENANTs }}
{{- range .PortConfigs }}
      {{ .Name }}:
        type: swp
        bridge:
          domain:
            br_default:
              access: {{ .VlanID }}
      vlan{{ .VlanID }}:
        type: svi
        vlan: {{ .VlanID }}
{{- if .IP }}
{{- if $.IsFNN }}
        ip:
          address:
            {{ .SviIP }}: {}
          vrf: tenant1
          vrr:
            address:
              {{ .IP }}: {}
            mac-address: {{ .VrrMAC }}
{{- else }}
        ip:
          address:
            {{ .IP }}: {}
{{- end }}
{{- end }}
{{- if .IP }}
{{- if $.IsFNN }}
        ip:
          vrr:
            enable: on
            state:
              up: {}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
    nve:
      vxlan:
        arp-nd-suppress: on
        enable: on
        source:
          address: {{ .LoopbackIP }}
    router:
      bgp:
        autonomous-system: {{ .ASN }}
        enable: on
        router-id: {{ .LoopbackIP }}
{{- if .IsFNN }}
      policy:
        community-list:
          route-leak:
            rule:
              '10':
                action: permit
                community:
                  100:100: {}
        route-map:
          vrf-loop:
            rule:
              '10':
                action:
                  deny: {}
                match:
                  community-list: route-leak
              '20':
                action:
                  permit: {}
                set:
                  community:
                    100:100: {}
      vrr:
        enable: on
{{- end }}
{{- if .IsFNN }}
    service:
      dhcp-relay:
{{- range .ComputeTENANTs }}
        {{ .Name }}:
          source-ip: gateway
          gateway-interface:
            {{ .Name }}: {}
          server:
{{- range $.DHCPServers}}
            {{ . }}: {}
{{- end }}
          interface:
{{- range .PortConfigs }}
            vlan{{ .VlanID }}: {}
{{- end }}
{{- end }}
{{- range .Uplinks}}
            {{ . }}: {}
{{- end }}
{{- range .Infrastructure }}
{{- range .L3Domains }}
{{- range .Services }}
            vlan{{ . }}_l3: {}
{{- end }}
{{- end }}
{{- end }}
{{- else }}
    service:
      dhcp-relay:
{{- range .ComputeTENANTs }}
        default:
          source-ip: gateway
          gateway-interface:
            lo: {}
          interface:
{{- range $.Uplinks}}
            {{ . }}: {}
{{- end }}
{{- range .PortConfigs }}
            vlan{{ .VlanID }}: {}
{{- end }}
          server:
{{- range $.DHCPServers}}
            {{ . }}: {}
{{- end }}
{{- end }}
{{- end }}
    system:
      hostname: {{ .DPUHostname }}
    vrf:
      default:
        router:
          bgp:
            address-family:
              ipv4-unicast:
                enable: on
                multipaths:
                  ebgp: 128
                redistribute:
                  connected:
                    enable: on
              l2vpn-evpn:
                enable: on
            enable: on
            neighbor:
{{- range .RouteServers }}
              {{ . }}:
                peer-group: routeserver
                type: numbered
{{- end }}
{{- range .Uplinks}}
              {{ . }}:
                peer-group: underlay
                type: unnumbered
{{- end }}
            path-selection:
              multipath:
                aspath-ignore: on
            peer-group:
              routeserver:
                address-family:
                  ipv4-unicast:
                    enable: off
                  l2vpn-evpn:
                    enable: on
                multihop-ttl: 255
                remote-as: external
                update-source: lo
              underlay:
                remote-as: external
{{- if .IsFNN }}
{{- range .Infrastructure }}
{{- range .L3Domains }}
      {{ .Name }}:
        evpn:
          enable: on
          vni:
            '{{ .L3VNI }}': {}
        loopback:
          ip:
            address:
              {{ .VRFloopback }}/32: {}
        router:
          bgp:
            address-family:
              ipv4-unicast:
                enable: on
                redistribute:
                  connected:
                    enable: on
                route-export:
                  to-evpn:
                    enable: on
                route-import:
                  from-vrf:
                    enable: on
                    list:
{{ $l3domain := .Name }}
{{- range $.ComputeTENANTs }}
{{- range .ExternalAccess}}
{{- if eq $l3domain .Name }}
                      {{ .Name }}: {}
{{- end }}
{{- end }}
{{- end }}
                    route-map: vrf-loop
              l2vpn-evpn:
                enable: on
            autonomous-system: {{ $.ASN }}
            enable: on
            router-id: {{ .VRFloopback }}
{{- end }}
{{- end }}
{{- range .ComputeTENANTs }}
      {{ .Name }}:
        evpn:
          enable: on
          vni:
            '{{ .L3VNI }}': {}
        loopback:
          ip:
            address:
              {{ .VRFloopback }}/32: {}
        router:
          bgp:
            address-family:
              ipv4-unicast:
                enable: on
                redistribute:
                  connected:
                    enable: on
                route-export:
                  to-evpn:
                    enable: on
                route-import:
                  from-vrf:
                    enable: on
                    list:
{{- range .ExternalAccess}}
                      {{ . }}: {}
{{- end }}
                    route-map: vrf-loop
            autonomous-system: {{ $.ASN }}
            enable: on
            router-id: {{ .VRFloopback }}
{{- end }}
{{- end }}
