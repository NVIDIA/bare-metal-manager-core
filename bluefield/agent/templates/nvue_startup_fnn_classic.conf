{{- $storage_enabled := false -}}
- header:
    model: VX
    nvue-api-version: nvue_v1
    rev-id: 1.0
    version: Cumulus Linux 5.6.0
- set:
    bridge:
      domain:
        br_default:
          vlan:
{{- range .ComputeTENANTs }}
 {{- range .PortConfigs }}
  {{- if .L2VNI }}
            '{{ .VlanID }}':
              vni:
                '{{ .L2VNI }}': {}
  {{- else }}
            '{{ .VlanID }}': {}
  {{- end }}
 {{- end }}
{{- end }}
    evpn:
      enable: on
    interface:
      lo:
        ip:
          address:
            {{ .LoopbackIP }}/32: {}
        type: loopback
      pf0dpu1_sf:
        ip:
          address:
            169.254.169.253/30: {}
{{- if and $storage_enabled (not .StorageTarget) }}
      pf0dpu3_sf:
        ip:
          address:
            {{ $.StorageDpuIP }}: {}
        vrf: storage
{{- end }}
{{- range .Uplinks}}
      {{ . }}:
        type: swp
{{- end }}
{{- range .ComputeTENANTs }}
 {{- range .PortConfigs }}
      {{ .InterfaceName }}:
        type: swp
        bridge:
          domain:
            br_default:
              access: {{ .VlanID }}
  {{- if not $.UseAdminNetwork }}
   {{- if and $storage_enabled (not .StorageTarget) }}
        acl:
          ACL_tenancy:
            inbound: {}
          drop_dhcp_flood_over_overlay:
            inbound: {}
      vlan{{ .VlanID }}:
        type: svi
        vlan: {{ .VlanID }}
    {{- if .IP }}
        ip:
          address:
            {{ .SviIP }}: {}
          vrf: {{ .VrfName }}
          vrr:
            address:
              {{ .IP }}: {}
            enable: on
            mac-address: {{ .SviMAC }}
            state:
              up: {}
    {{- end }}
   {{- end }}
  {{- end }}
  {{- if $.UseAdminNetwork }}
      vlan{{ .VlanID }}:
        type: svi
        vlan: {{ .VlanID }}
   {{- if .IP }}
        ip:
          address:
            {{ .IP }}: {}
   {{- end }}
  {{- end }}
  {{- if and $storage_enabled .StorageTarget }}
      vlan{{ .VlanID }}:
        type: svi
        vlan: {{ .VlanID }}
   {{- if .IP }}
        ip:
          address:
            {{ .SviIP }}: {}
          vrf: storage
   {{- end }}
  {{- end }}
 {{- end }}
{{- end }}
    nve:
      vxlan:
        arp-nd-suppress: on
        enable: on
        source:
          address: {{ .LoopbackIP }}
    router:
      bgp:
        autonomous-system: {{ .ASN }}
        enable: on
        router-id: {{ .LoopbackIP }}
      vrr:
        enable: on
      policy:
        prefix-list:
          FORGE_FROM_UNDERLAY:
            rule:
              '10':
                action: permit
                match:
                  0.0.0.0/0: {}
              '1000':
                action: deny
                match:
                  any: {}
          dpu_from_instance:
            rule:
              '10':
                action: permit
                match:
                  0.0.0.0/0:
                    min-prefix-len: 32
        route-map:
          dpu_to_instance:
            rule:
              '10':
                action:
                  deny: {}
    vrf:
      default:
        router:
          nexthop-tracking:
            ipv4:
              resolved-via-default: on
          bgp:
            address-family:
              ipv4-unicast:
                enable: on
                multipaths:
                  ebgp: 128
                redistribute:
                  connected:
                    enable: on
              l2vpn-evpn:
                enable: on
            enable: on
            neighbor:
{{- range .RouteServers }}
              {{ . }}:
                peer-group: routeserver
                type: numbered
{{- end }}
{{- range .Uplinks}}
              {{ . }}:
                peer-group: underlay
                type: unnumbered
{{- end }}
            path-selection:
              multipath:
                aspath-ignore: on
            peer-group:
              routeserver:
                address-family:
                  ipv4-unicast:
                    enable: off
                  l2vpn-evpn:
                    enable: on
                multihop-ttl: 255
                remote-as: external
                update-source: lo
              underlay:
                remote-as: external
                address-family:
                  ipv4-unicast:
                    policy:
                      inbound:
                        prefix-list: FORGE_FROM_UNDERLAY
{{- if not .UseAdminNetwork }}
 {{- if and $storage_enabled (not .StorageTarget) }}
  {{- range .ComputeTENANTs }}
      {{ .VrfName }}:
        evpn:
          enable: on
          vni:
            '{{ .L3VNI }}': {}
        loopback:
          ip:
            address:
              {{ .VrfLoopback }}: {}
        router:
          bgp:
            address-family:
              ipv4-unicast:
                enable: on
                redistribute:
                  connected:
                    enable: on
                route-export:
                  to-evpn:
                    enable: on
            enable: on
            neighbor:
   {{- range .AccessVLANs}}
    {{- if .HostIP }}
              {{ .HostIP }}:
                passive-mode: on
                peer-group: tenant
                type: numbered
    {{- end }}
   {{- end }}
            peer-group:
              tenant:
                address-family:
                  ipv4-unicast:
                    policy:
                      inbound:
                        prefix-list: dpu_from_instance
                      outbound:
                        route-map: dpu_to_instance
                nexthop-connected-check: off
                remote-as: external
                timers:
                  connection-retry: 10
                  hold: 9
                  keepalive: 3
                  route-advertisement: none
            route-import:
              from-evpn:
                route-target:
                  11414:{{ $.InternetL3VNI }}: {}
  {{- end }}
 {{- end }}
{{- end }}
{{- if and $storage_enabled .StorageTarget }}
      storage:
        evpn:
          enable: on
          vni:
            '{{ .StorageL3VNI }}': {}
        loopback:
          ip:
            address:
              {{ .StorageLoopback }}: {}
        router:
          static:
            {{ $.DPUstorageprefix }}:
              address-family: ipv4-unicast
              via:
                service:
                  type: interface
          bgp:
            address-family:
              ipv4-unicast:
                aggregate-route:
                  {{ $.DPUstorageprefix }}: {}
                enable: on
                redistribute:
                  connected:
                    enable: on
                  static:
                    enable: on
                route-export:
                  to-evpn:
                    enable: on
                    route-map: aggregate-service
            enable: on
            route-import:
              from-evpn:
                route-target:
                  auto: {}
{{- end }}
{{- if not .UseAdminNetwork }}
    acl:
      ACL_tenancy:
        rule:
 {{- range .ComputeTENANTs }}
  {{- range .PortConfigs }}
   {{- $netname := .InterfaceName }}
   {{- range .VpcPrefixes }}
          '{{ .Index }}':
            action:
              permit: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
   {{- end }}
  {{- end }}
 {{- end }}
 {{- range .DenyPrefixes }}
          '{{ .Index }}':
            action:
              deny: {}
            match:
              ip:
                dest-ip: {{ .Prefix }}
 {{- end }}
        type: ipv4
      drop_dhcp_flood_over_overlay:
        rule:
          '10':
            action:
              deny: {}
            hw-offload: off
            match:
              ip:
                dest-ip: 255.255.255.255
                protocol: udp
                dest-port:
                  '67': {}
                source-port:
                  '68': {}
        type: ipv4
{{- end }}
