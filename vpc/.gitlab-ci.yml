# Copyright 2021 NVIDIA CORPORATION.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

variables:
  NSPECT_ID: NSPECT-57MC-92NZ
  APPLICATION_NAME: forge-connectivity
  APPLICATION_DOCKERFILE:  build/images/forge/Dockerfile.nobuild
  KUSTOMIZE_LOCATION: config

include:
  - project: 'nvmetal/gitlab-templates'
    ref: main
    file:
      - defaults.gitlab-ci.yml

build:
  stage: build
  before_script:
    - go mod download
  script:
    - make
    - make manifests
    - ci/check-codegen.sh
    - ci/check-manifest.sh
  artifacts:
    paths:
      - bin/manager
      - bin/grpc-server
      - bin/agent
      - config/forge.yaml
      - config/forge-dev.yaml
      - config/forge-canary.yaml
    expire_in: 1 day

test:
  stage: test
  before_script:
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get install -y isc-dhcp-relay
    - go get -u github.com/jstemmer/go-junit-report
  script:
    - make test
  tags:
    - forge
  artifacts:
    when: always
    reports:
      junit: report.xml

build-push-kustomize:
  before_script:
    - apt-get update
    - apt-get install -y gettext-base
    - make manifests-ci

deploy_dev1:
  extends: .deploy_kustomize
  environment: 
    name: dev1
    deployment_tier: development

deploy_dev2:
  extends: .deploy_kustomize
  needs: 
    - prepare-ci
    - deploy_dev1
  environment: 
    name: dev2
    deployment_tier: staging

#TODO Change this to label based run
e2e-test:
  stage: e2e-test
  needs:
    - job: build-push-container
      artifacts: true
    - job: prepare-ci
  variables:
    FORGE_TAG: $VERSION
  trigger:
    project: nvmetal/e2e-test
    strategy: depend
  rules:
    - if: $CI_COMMIT_MESSAGE =~ /.*test-all.*/
