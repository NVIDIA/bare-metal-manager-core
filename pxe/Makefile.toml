# SPDX-FileCopyrightText: Copyright (c) 2021-2023 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: LicenseRef-NvidiaProprietary
#
# NVIDIA CORPORATION, its affiliates and licensors retain all intellectual
# property and proprietary rights in and to this material, related
# documentation and any modifications thereto. Any use, reproduction,
# disclosure or distribution of this material and related documentation
# without an express license agreement from NVIDIA CORPORATION or
# its affiliates is strictly prohibited.
[env]
REPO_ROOT = { script = [
  "dirname $(cargo locate-project --message-format plain --workspace)",
] }
FORGE_CA_PATH = { value = "${REPO_ROOT}/dev/forge_prodroot.pem" }

# BFB stuff
BFB_NAME = "bf-bundle-2.9.2-32_25.02_ubuntu-22.04_prod.bfb"
BFB_UPSTREAM_LOCATION = "https://content.mellanox.com/BlueField/BFBs/Ubuntu22.04"
URM_LOCATION = "https://urm.nvidia.com/artifactory/sw-forge-admins-generic-local/build-artifacts/${HBN_VERSION}"
DOCA_VERSION = "2.9.2"
HBN_VERSION = "2.4.2"
# The upstream config url no longer works, and the file must be retrieved manually from the following page, then downloaded
# to the machine that is running the upload job
# https://catalog.ngc.nvidia.com/orgs/nvidia/teams/doca/resources/doca_container_configs/version
DOCA_CONFIG_FILENAME = "doca_hbn_2.4.2"
HBN_UPSTREAM_CONFIG_URL = "file:///path/to/${DOCA_CONFIG_FILENAME}.zip"
IPXE_BANNER_VERSION = { script = [
  "echo ${VERSION:-$(git describe --tags --first-parent --always --long)}",
] }
# The actual hbn container name NEVER cleanly matches the doca/hbn versions, so we paste it here.
DOCA_HBN_URI = "nvcr.io/nvidia/doca/doca_hbn:2.4.2-doca2.9.2-32"
DPU_AGENT_PKG_VERSION = { script = [
  "echo $(git describe --tags --first-parent --always --long | cut -c 2-)",
] }
BUILD_LOCATION = "/tmp/bfb-dump/initramfs-tmp"

# BF3-23.10-5
BF3_PREINGESTION_BMC_PACKAGE = "https://urm.nvidia.com/artifactory/sw-bmc-generic-local/BF3/BF3BMC-23.10-5/OPN/bf3-bmc-23.10-5_opn.fwpkg"

[tasks.upload-bfb-artifacts-to-urm]
env = { "BFB_LOCATION" = "${BFB_UPSTREAM_LOCATION}", "HBN_CONFIG_URL" = "${HBN_UPSTREAM_CONFIG_URL}" }
run_task = "internal-upload-bfb-artifacts-to-urm"

# Do not directly call this as the variables are set in a non internal task
[tasks.internal-upload-bfb-artifacts-to-urm]
dependencies = [
  "bfb-cleanup-tmp",
  "bfb-create-tmp",
  "bfb-download",
  "bfb-mv-to-build-dir",
  "bfb-hbn-download",
  "bfb-hbn-export",
  "download-hbn-installer-to-bfb",
  "upload-artifacts-to-artifactory",
]

[tasks.bfb-mv-to-build-dir]
command = "mv"
args = ["/tmp/bfb-dump/${BFB_NAME}", "${BUILD_LOCATION}"]

[tasks.upload-artifacts-to-artifactory]
command = "jf"
args = [
  "rt",
  "upload",
  "./*",
  "sw-forge-admins-generic/build-artifacts/${HBN_VERSION}/",
  "--server-id=urm",
]
cwd = "${BUILD_LOCATION}" # jf will try to upload the full path specified if the tool is executed out of the target directory


[tasks.build-boot-artifacts-x86_64]
dependencies = [
  "mkdir-static-x86_64",
  "cleanup-pxe-submodule",
  { name = "build-cli", path = "${REPO_ROOT}" },
  "build",
  "create-ephemeral-image-x86_64",
  "ipxe-x86_64",
]

[tasks.build-boot-artifacts-minikube-x86_64]
dependencies = [
  "mkdir-static-x86_64",
  { name = "build-cli-ci", path = "${REPO_ROOT}" },
  "create-ephemeral-image-x86_64",
  "ipxe-x86_64",
]

[tasks.build-boot-artifacts-x86_64-ci]
dependencies = [
  "mkdir-static-x86_64",
  { name = "build-cli-ci", path = "${REPO_ROOT}" },
  "ipxe-x86_64-ci",
]

[tasks.build-boot-artifacts-aarch64]
dependencies = [
  "mkdir-static-aarch64",
  "cleanup-pxe-submodule",
  { name = "build-cli-cross-aarch64", path = "${REPO_ROOT}" },
  "bfb-aarch64",
  "ipxe-aarch64",
  "setup-apt-repo",
]

[tasks.build-boot-artifacts-aarch64-ci]
dependencies = [
  "mkdir-static-aarch64",
  { name = "build-cli-ci", path = "${REPO_ROOT}" },
  "bfb-aarch64-ci",
  "ipxe-aarch64-ci",
  "setup-apt-repo",
]

[tasks.create-ephemeral-image-x86_64-ci]
category = "Ephemeral Image"
dependencies = [
  "mkosi-generate-build-tmpdir",
  "copy-forge-scout-ci-x86_64",
  "copy-forge-prod-root-ca-x86_64",
  "mkosi-build-scout-x86_64",
  "mkosi-build-qcow-imager",
  "mkosi-copy-qcow-imager-to-webroot-x86_64",
  "mkosi-copy-scout-to-webroot-x86_64",
  "mkosi-clean-qcow-imager",
  "mkosi-clean-scout-x86_64",
]

[tasks.create-ephemeral-image-x86_64]
category = "Ephemeral Image"
dependencies = [
  "mkosi-generate-build-tmpdir",
  "copy-forge-scout-x86_64",
  "copy-forge-dev-root-ca-x86_64",
  "mkosi-build-scout-x86_64",
  "mkosi-build-qcow-imager",
  "mkosi-copy-qcow-imager-to-webroot-x86_64",
  "mkosi-copy-scout-to-webroot-x86_64",
  "mkosi-clean-qcow-imager",
  "mkosi-clean-scout-x86_64",
]

[tasks.create-ephemeral-image-aarch64-ci]
category = "Ephemeral Image"
dependencies = [
  "mkosi-generate-build-tmpdir",
  "copy-forge-scout-ci-aarch64",
  "copy-forge-prod-root-ca-aarch64",
  "mkosi-build-scout-aarch64",
  "mkosi-copy-scout-to-webroot-aarch64",
  "mkosi-clean-scout-aarch64",
]

[tasks.create-ephemeral-image-aarch64]
category = "Ephemeral Image"
dependencies = [
  "mkosi-generate-build-tmpdir",
  "copy-forge-scout-aarch64",
  "copy-forge-dev-root-ca-aarch64",
  "mkosi-build-scout-aarch64",
  #"mkosi-build-qcow-imager",
  #"mkosi-copy-qcow-imager-to-webroot-aarch64",
  "mkosi-copy-scout-to-webroot-aarch64",
  "mkosi-clean-scout-aarch64",
]

[tasks.cleanup-pxe-submodule]
category = "ipxe"
cwd = "${REPO_ROOT}/pxe/ipxe/upstream"
script = '''
set -e

git reset --hard --quiet
git clean -fd --quiet
'''

[tasks.mkdir-static-aarch64]
category = "ipxe"
script = '''
  mkdir -p "${REPO_ROOT}/pxe/static/blobs/internal/aarch64"
  mkdir -p "${REPO_ROOT}/pxe/static/blobs/internal/apt/dists/focal/main/binary-arm64"
  mkdir -p "${REPO_ROOT}/pxe/static/blobs/internal/apt/pool/base/f/forge-dpu"
  mkdir -p "${REPO_ROOT}/pxe/static/blobs/internal/firmware"
'''

[tasks.mkdir-static-x86_64]
category = "ipxe"
script = '''
  mkdir -p "${REPO_ROOT}/pxe/static/blobs/internal/x86_64"
  mkdir -p "${REPO_ROOT}/pxe/static/blobs/internal/firmware"
'''

[tasks.copy-forge-prod-root-ca-x86_64]
category = "Copy Forge Root CA in CI"
command = "cp"
args = [
  "-f",
  "${FORGE_CA_PATH}",
  "mkosi.profiles/scout-x86_64/mkosi.extra/opt/forge/forge_root.pem",
]

[tasks.copy-forge-prod-root-ca-aarch64]
category = "Copy Forge Root CA in CI"
command = "cp"
args = [
  "-f",
  "${FORGE_CA_PATH}",
  "mkosi.profiles/scout-aarch64/mkosi.extra/opt/forge/forge_root.pem",
]

[tasks.copy-forge-dev-root-ca-x86_64]
category = "Copy Forge Root CA"
command = "cp"
args = [
  "-f",
  "${REPO_ROOT}/dev/certs/forge_developer_local_only_root_cert_pem",
  "mkosi.profiles/scout-x86_64/mkosi.extra/opt/forge/forge_root.pem",
]

[tasks.copy-forge-dev-root-ca-aarch64]
category = "Copy Forge Root CA"
command = "cp"
args = [
  "-f",
  "${REPO_ROOT}/dev/certs/forge_developer_local_only_root_cert_pem",
  "mkosi.profiles/scout-aarch64/mkosi.extra/opt/forge/forge_root.pem",
]

[tasks.copy-forge-scout-x86_64]
category = "Copy Forge Scout locally"
command = "cp"
args = [
  "${REPO_ROOT}/target/release/forge-scout",
  "mkosi.profiles/scout-x86_64/mkosi.extra/opt/forge/",
]

[tasks.copy-forge-scout-aarch64]
category = "Copy Forge Scout locally"
command = "cp"
args = [
  "${REPO_ROOT}/target/release/forge-scout",
  "mkosi.profiles/scout-aarch64/mkosi.extra/opt/forge/",
]

[tasks.copy-forge-scout-ci-x86_64]
category = "Copy Forge Scout in CI"
command = "cp"
args = [
  "${REPO_ROOT}/target/debug/forge-scout",
  "mkosi.profiles/scout-x86_64/mkosi.extra/opt/forge/",
]

[tasks.copy-forge-scout-ci-aarch64]
category = "Copy Forge Scout in CI"
command = "cp"
args = [
  "${REPO_ROOT}/target/debug/forge-scout",
  "mkosi.profiles/scout-aarch64/mkosi.extra/opt/forge/",
]


[tasks.mkosi-clean-qcow-imager]
category = "Ephemeral Image"
command = "${REPO_ROOT}/pxe/mkosi/bin/mkosi"
args = ["--profile", "qcow-imager", "--output-dir=${MKOSI_BUILD_TMP}", "clean"]

[tasks.mkosi-clean-scout-x86_64]
category = "Ephemeral Image"
command = "${REPO_ROOT}/pxe/mkosi/bin/mkosi"
args = ["--profile", "scout-x86_64", "--output-dir=${MKOSI_BUILD_TMP}", "clean"]

[tasks.mkosi-clean-scout-aarch64]
category = "Ephemeral Image"
command = "${REPO_ROOT}/pxe/mkosi/bin/mkosi"
args = ["--profile", "scout-aarch64", "--output-dir=${MKOSI_BUILD_TMP}", "clean"]

[tasks.mkosi-generate-build-tmpdir]
category = "Ephemeral Image"
script_runner = "@duckscript"
script = '''
tmp_name = exec --fail-on-error mktemp -d -p /tmp mkosi.output-XXXXXX
tmp_name = replace ${tmp_name.stdout} "\n" ""
set_env MKOSI_BUILD_TMP ${tmp_name}
'''

# `depmod` on our runners is in `/sbin`, so add to PATH
[tasks.mkosi-build-scout-x86_64]
category = "Ephemeral Image"
command = "/bin/bash"
args = [
  "-c",
  "export PATH=${PATH}:/sbin && ${REPO_ROOT}/pxe/mkosi/bin/mkosi --profile scout-x86_64 --output-dir=${MKOSI_BUILD_TMP} build",
]

[tasks.mkosi-build-scout-aarch64]
category = "Ephemeral Image"
command = "/bin/bash"
args = [
  "-c",
  "export PATH=${PATH}:/sbin && ${REPO_ROOT}/pxe/mkosi/bin/mkosi --profile scout-aarch64 --output-dir=${MKOSI_BUILD_TMP} build",
]

[tasks.mkosi-build-qcow-imager]
category = "Ephemeral Image"
command = "/bin/bash"
args = [
  "-c",
  "export PATH=${PATH}:/sbin && ${REPO_ROOT}/pxe/mkosi/bin/mkosi --profile qcow-imager --output-dir=${MKOSI_BUILD_TMP} build",
]

[tasks.mkosi-copy-qcow-imager-to-webroot-x86_64]
category = "Ephemeral Image"
command = "cp"
args = [
  "${MKOSI_BUILD_TMP}/qcow-imager.efi",
  "static/blobs/internal/x86_64/qcow-imager.efi",
]
dependencies = ["mkdir-static-x86_64"]

[tasks.mkosi-copy-qcow-imager-to-webroot-aarch64]
category = "Ephemeral Image"
command = "cp"
args = [
  "${MKOSI_BUILD_TMP}/qcow-imager.efi",
  "static/blobs/internal/aarch64/qcow-imager.efi",
]
dependencies = ["mkdir-static-x86_64"]

[tasks.mkosi-copy-scout-to-webroot-x86_64]
category = "Ephemeral Image"
command = "cp"
args = ["${MKOSI_BUILD_TMP}/scout.efi", "static/blobs/internal/x86_64/scout.efi"]
dependencies = ["mkdir-static-x86_64"]

[tasks.mkosi-copy-scout-to-webroot-aarch64]
category = "Ephemeral Image"
command = "cp"
args = ["${MKOSI_BUILD_TMP}/scout.efi", "static/blobs/internal/aarch64/scout.efi"]
dependencies = ["mkdir-static-aarch64"]

[tasks.ipxe-x86_64]
category = "iPXE Kernel"
description = "Build iPXE kernel for x86_64 (Legacy BIOS, EFI) and move to the carbide static webroot"
dependencies = [
  "ipxe-config",
  "ipxe-patch-measured-boot",
  "ipxe-patch-watchdog-timeout",
  "ipxe-install-efi-x86_64",
]

[tasks.ipxe-x86_64-ci]
category = "iPXE Kernel"
description = "Build iPXE kernel for x86_64 (Legacy BIOS, EFI) and move to the carbide static webroot"
dependencies = [
  "ipxe-config",
  "ipxe-patch-measured-boot",
  "ipxe-patch-watchdog-timeout",
  "ipxe-install-efi-x86_64",
]

[tasks.ipxe-config]
category = "iPXE Kernel"
description = "Copy the Carbide specific iPXE config headers to the input directory"
script = "cp ipxe/local/*.h ipxe/upstream/src/config/local/"

[tasks.ipxe-patch-mlnx]
category = "iPXE Kernel"
description = "Patch the iPXE for Mellanox DPU NIC"
cwd = "${REPO_ROOT}/pxe/ipxe/upstream"
script = '''
    PATCH="${REPO_ROOT}/pxe/ipxe/local/0001-fix-update-to-allow-iPXE-to-boot-on-BlueField-NICs.patch"
    echo "Testing if patch is reversible (i.e. already applied)"
    if ! patch --dry-run -p1 --reverse --forward -i "${PATCH}" >/dev/null; then
      echo "Reversing the patch failed, forward applying it."
      patch -p1 --forward -i "${PATCH}"
    else
      echo "Reversing would be successful, assuming patch is already applied"
    fi
'''

[tasks.ipxe-patch-measured-boot]
category = 'iPXE Kernel'
description = "Patch iPXE for measured boot and TPM support"
cwd = "${REPO_ROOT}/pxe/ipxe/upstream"
script = '''
    PATCH="${REPO_ROOT}/pxe/ipxe/local/0001-efi-Add-TPM-measurement-API-via-TCG-v1-and-TCG-v2-EF.patch"
    if test -f "${REPO_ROOT}/pxe/ipxe/upstream/src/config/tpm.h"; then
        echo "Patch already applied?"
    else
        patch -p1 --forward -i "${PATCH}"
    fi
'''

[tasks.ipxe-patch-watchdog-timeout]
category = 'iPXE Kernel'
description = "Patch iPXE to prevent watchdog timeout"
cwd = "${REPO_ROOT}/pxe/ipxe/upstream"
script = '''
    PATCH="${REPO_ROOT}/pxe/ipxe/local/0003-efi-prevent-load-image-watchdog-timeout.patch"
    # if patch is already applied, it will continue, in case of any other error it will fail
    OUT=$(patch -p1 --forward -i "${PATCH}") || echo "${OUT}" | grep "Skipping patch" -q || (echo "$OUT" && false)
'''

[tasks.ipxe-install-efi-x86_64]
category = "iPXE Kernel"
description = "Copy the x86_64 EFI iPXE kernel to the boot controller static files directory"
command = "mv"
args = [
  "ipxe/upstream/src/bin-x86_64-efi/snponly.efi",
  "static/blobs/internal/x86_64/ipxe.efi",
]
dependencies = ["ipxe-build-efi-x86_64"]

[tasks.ipxe-aarch64]
category = "iPXE Kernel"
description = "Build iPXE kernel for aarch64 (EFI) and move to the carbide static webroot"
dependencies = ["ipxe-config", "ipxe-patch-mlnx", "ipxe-install-efi-aarch64"]

[tasks.ipxe-aarch64-ci]
category = "iPXE Kernel"
description = "Build iPXE kernel for aarch64 (EFI) and move to the carbide static webroot"
dependencies = ["ipxe-config", "ipxe-patch-mlnx", "ipxe-install-efi-aarch64-ci"]

[tasks.ipxe-install-efi-aarch64]
category = "iPXE Kernel"
description = "Copy the aarch64 EFI iPXE kernel to the boot controller static files directory"
command = "mv"
args = [
  "ipxe/upstream/src/bin-arm64-efi/ipxe.efi",
  "static/blobs/internal/aarch64/ipxe.efi",
]
dependencies = ["ipxe-build-efi-aarch64"]

[tasks.ipxe-install-efi-aarch64-ci]
category = "iPXE Kernel"
description = "Copy the aarch64 EFI iPXE kernel to the boot controller static files directory"
command = "mv"
args = [
  "ipxe/upstream/src/bin-arm64-efi/ipxe.efi",
  "static/blobs/internal/aarch64/ipxe.efi",
]
dependencies = ["ipxe-build-efi-aarch64-ci"]

# This requires the GNU `ld`. It fails with LLVM's `lld`.
[tasks.ipxe-build-efi-x86_64]
category = "iPXE Kernel"
description = "Build the x86_64 EFI iPXE kernel"
command = "make"
args = [
  "-j",
  "bin-x86_64-efi/snponly.efi",
  "VERSION=${IPXE_BANNER_VERSION}",
  "EMBED=${REPO_ROOT}/pxe/ipxe/local/embed.ipxe",
  "DEBUG=tls",
]
cwd = "ipxe/upstream/src"

[tasks.ipxe-build-efi-aarch64]
category = "iPXE Kernel"
description = "Build the aarch64 EFI iPXE kernel on aarch64 gitlab runner"
command = "make"
args = [
  "-j",
  "CROSS_COMPILE=aarch64-linux-gnu-",
  "bin-arm64-efi/ipxe.efi",
  "VERSION=${IPXE_BANNER_VERSION}",
  "EMBED=${REPO_ROOT}/pxe/ipxe/local/embed.ipxe",
  "DEBUG=snp,tls",
]
cwd = "ipxe/upstream/src"

[tasks.ipxe-build-efi-aarch64-ci]
category = "iPXE Kernel"
description = "Build the aarch64 EFI iPXE kernel on aarch64 gitlab runner"
command = "make"
args = [
  "-j",
  "bin-arm64-efi/ipxe.efi",
  "VERSION=${IPXE_BANNER_VERSION}",
  "EMBED=${REPO_ROOT}/pxe/ipxe/local/embed.ipxe",
  "DEBUG=snp,tls",
]
cwd = "ipxe/upstream/src"

[tasks.bfb-aarch64-ci]
env = { "BFB_LOCATION" = "${URM_LOCATION}", "HBN_CONFIG_URL" = "${URM_LOCATION}/doca_container_configs.zip" }
run_task = "internal-bfb-aarch64-ci"

[tasks.bfb-aarch64]
env = { "BFB_LOCATION" = "${URM_LOCATION}", "HBN_CONFIG_URL" = "${URM_LOCATION}/doca_container_configs.zip" }
run_task = "internal-bfb-aarch64"

[tasks.internal-bfb-aarch64-ci]
category = "iPXE Kernel"
description = "Build iPXE kernel for aarch64 (EFI) and move to the carbide static webroot"
dependencies = [
  "bfb-cleanup-tmp",
  "bfb-create-tmp",
  "bfb-download",
  "bfbtools-download",
  "bfb-extract",
  "bfb-extract-efi-ci",
  "download-docker-containers",
  "bfb-extract-ifconfig",
  "bfb-add-scout-to-bfb-ci",
  "bfb-add-debs-to-bfb",
  "bfb-add-nvinit-setup-to-bfb",
  "bfb-add-prod-forge-root-ca-to-bfb",
  "download-hbn-installer-to-bfb",
  "mkdir-hbn-folder-in-bfb",
  "unzip-hbn-folder-in-bfb",
  "mv-hbn-configs-to-bfb",
  "mv-hbn-scripts-to-bfb",
  "cleanup-hbn-scripts",
  { name = "build-forge-dpu-deb-ci", path = "${REPO_ROOT}/bluefield" },
  "cp-forge-dpu-package-to-bfb",
  "bfb-copy-efi",
  "bfb-remove-extracted-efi",
  "replace-bfpxe-script",
  "bfb-rebuild-rootfs",
  "bfb-copy-rootfs",
]

[tasks.internal-bfb-aarch64]
category = "iPXE Kernel"
description = "Build iPXE kernel for aarch64 (EFI) and move to the carbide static webroot"
workspace = false
dependencies = [
  "bfb-cleanup-tmp",
  "bfb-create-tmp",
  "bfb-download",
  "bfbtools-download",
  "bfb-extract",
  "bfb-extract-efi",
  "download-docker-containers",
  "bfb-extract-ifconfig",
  "bfb-add-scout-to-bfb",
  "bfb-add-debs-to-bfb",
  "bfb-add-nvinit-setup-to-bfb",
  "bfb-add-dev-forge-root-ca-to-bfb",
  "download-hbn-installer-to-bfb",
  "mkdir-hbn-folder-in-bfb",
  "unzip-hbn-folder-in-bfb",
  "mv-hbn-configs-to-bfb",
  "mv-hbn-scripts-to-bfb",
  "cleanup-hbn-scripts",
  { name = "build-forge-dpu-deb-local", path = "${REPO_ROOT}/bluefield" },
  "cp-forge-dpu-package-to-bfb",
  "bfb-copy-efi",
  "bfb-remove-extracted-efi",
  "replace-bfpxe-script",
  "bfb-rebuild-rootfs",
  "bfb-copy-rootfs",
]

[tasks.bfb-cleanup-tmp]
category = "iPXE Kernel"
description = "Download the BFB on aarch64 gitlab runner"
command = "rm"
args = ["-rf", "${BUILD_LOCATION}"]

[tasks.bfb-create-tmp]
category = "iPXE Kernel"
description = "Download the BFB on aarch64 gitlab runner"
command = "mkdir"
args = ["-p", "${BUILD_LOCATION}"]

[tasks.bfb-download]
category = "iPXE Kernel"
description = "Download the BFB on aarch64 gitlab runner"
command = "curl"
args = ["${BFB_LOCATION}/${BFB_NAME}", "--output", "${BFB_NAME}"]
cwd = "/tmp/bfb-dump"

[tasks.bfbtools-download]
category = "iPXE Kernel"
description = "Download the BFB tools on aarch64 gitlab runner"
command = "curl"
args = [
  "https://raw.githubusercontent.com/Mellanox/rshim-user-space/refs/heads/master/scripts/mlx-mkbfb",
  "--output",
  "mlx-mkbfb",
]
cwd = "/tmp/bfb-dump"

[tasks.bfb-hbn-download]
category = "iPXE Kernel"
description = "Download the hbn doca container on aarch64 gitlab runner"
command = "docker"
args = ["pull", "--platform=linux/arm64", "${DOCA_HBN_URI}"]

[tasks.bfb-extract]
category = "iPXE Kernel"
description = "Extract the BFB on aarch64 gitlab runner"
command = "python3"
args = ["mlx-mkbfb", "-x", "${BFB_NAME}"]
cwd = "/tmp/bfb-dump"

[tasks.bfb-extract-efi]
category = "iPXE Kernel"
description = "Extract the BFB initramfs on aarch64 gitlab runner"
script = [
  "gzip -d < /tmp/bfb-dump/dump-initramfs-v0 | doas cpio -id && doas chown -R $USER .",
]
cwd = "${BUILD_LOCATION}"

[tasks.bfb-extract-efi-ci]
category = "iPXE Kernel"
description = "Extract the BFB initramfs on aarch64 gitlab runner"
script = ["gzip -d < /tmp/bfb-dump/dump-initramfs-v0 | cpio -id"]
cwd = "${BUILD_LOCATION}"

[tasks.bfb-hbn-export]
category = "iPXE Kernel"
description = "export the hbn doca container on aarch64 gitlab runner"
command = "docker"
args = ["save", "--output=doca_hbn.tar", "${DOCA_HBN_URI}"]
cwd = "${BUILD_LOCATION}"

[tasks.download-docker-containers]
category = "iPXE Kernel"
description = "Download all the docker containers from artifactory"
command = "curl"
args = [
  "--remote-name-all",
  "${URM_LOCATION}/{doca_hbn}.tar",
]
cwd = "${BUILD_LOCATION}"

[tasks.bfb-extract-ifconfig]
category = "iPXE Kernel"
description = "extract ifconfig from ubuntu tar"
command = "tar"
args = ["xJf", "ubuntu/image.tar.xz", "./usr/sbin/ifconfig"]
cwd = "${BUILD_LOCATION}"

[tasks.bfb-add-prod-forge-root-ca-to-bfb]
category = "iPXE Kernel"
description = "Add the forge root CA to the bfb"
command = "cp"
args = ["${FORGE_CA_PATH}", "${BUILD_LOCATION}/forge_root.pem"]

[tasks.bfb-add-dev-forge-root-ca-to-bfb]
category = "iPXE Kernel"
description = "Add the forge root CA to the bfb"
command = "cp"
args = [
  "${REPO_ROOT}/dev/certs/forge_developer_local_only_root_cert_pem",
  "${BUILD_LOCATION}/forge_root.pem",
]

[tasks.cleanup-old-debs]
category = "iPXE Kernel"
description = "remove all the old debs in the target folder"
command = "find"
args = [
  "${REPO_ROOT}/pxe/debs",
  "-type",
  "f",
  "-not",
  "-name",
  "libnss-exec_0.2.0-1_arm64.deb",
  "-delete",
]

[tasks.download-debs-for-bfb]
category = "iPXE Kernel"
description = "wget the debs to nvinit_setup"
command = "wget"
args = [
  "-i",
  "${REPO_ROOT}/pxe/wget_deb_urls",
  "--directory-prefix=${REPO_ROOT}/pxe/debs",
]
cwd = "${REPO_ROOT}/pxe"
dependencies = ["cleanup-old-debs"]

[tasks.bfb-add-debs-to-bfb]
category = "iPXE Kernel"
description = "Add debs folder to the bfb"
command = "cp"
args = ["-R", "${REPO_ROOT}/pxe/debs", "${BUILD_LOCATION}"]
dependencies = ["download-debs-for-bfb"]

[tasks.bfb-add-nvinit-setup-to-bfb]
category = "iPXE Kernel"
description = "Add nvinit_setup folder to the bfb"
command = "cp"
args = ["-R", "${REPO_ROOT}/pxe/nvinit_setup", "${BUILD_LOCATION}"]

[tasks.bfb-add-scout-to-bfb-ci]
category = "iPXE Kernel"
description = "Add the scout to the bfb"
command = "cp"
args = ["${REPO_ROOT}/target/debug/forge-scout", "${BUILD_LOCATION}"]

[tasks.bfb-add-scout-to-bfb]
category = "iPXE Kernel"
description = "Add the scout to the bfb"
command = "cp"
args = [
  "${REPO_ROOT}/target/aarch64-unknown-linux-gnu/release/forge-scout",
  "${BUILD_LOCATION}",
]
dependencies = [{ name = "build-cli-cross-aarch64", path = "${REPO_ROOT}" }]

[tasks.download-hbn-installer-to-bfb]
category = "iPXE Kernel"
description = "Add the HBN installer to the bfb"
command = "curl"
args = [
  "-L",
  "${HBN_CONFIG_URL}",
  "--output",
  "${BUILD_LOCATION}/doca_container_configs.zip",
]

[tasks.mkdir-hbn-folder-in-bfb]
category = "iPXE Kernel"
description = "Make the HBN script target directory to the bfb"
command = "mkdir"
args = ["${BUILD_LOCATION}/doca_container_configs"]

[tasks.unzip-hbn-folder-in-bfb]
category = "iPXE Kernel"
description = "Unzip the HBN scripts to a temp directory"
command = "unzip"
args = ["${BUILD_LOCATION}/doca_container_configs.zip", "-d", "temp"]
cwd = "${BUILD_LOCATION}/doca_container_configs"

[tasks.mv-hbn-configs-to-bfb]
category = "iPXE Kernel"
description = "Add the HBN configs to the bfb"
command = "mv"
args = ["temp/${DOCA_CONFIG_FILENAME}/scripts/${HBN_VERSION}/", "scripts"]
cwd = "${BUILD_LOCATION}/doca_container_configs"

[tasks.mv-hbn-scripts-to-bfb]
category = "iPXE Kernel"
description = "Add the HBN scripts to the bfb"
command = "mv"
args = ["temp/${DOCA_CONFIG_FILENAME}/configs/${HBN_VERSION}/", "configs"]
cwd = "${BUILD_LOCATION}/doca_container_configs"

[tasks.cleanup-hbn-scripts]
category = "iPXE Kernel"
description = "Cleanup the HBN scripts"
command = "rm"
args = ["-rf", "temp"]
cwd = "${BUILD_LOCATION}/doca_container_configs"

[tasks.cp-forge-dpu-package-to-bfb]
category = "iPXE Kernel"
description = "Copy aarch64 EFI iPXE debian file"
command = "cp"
args = [
  "${REPO_ROOT}/bluefield/forge-dpu_${DPU_AGENT_PKG_VERSION}.deb",
  "${BUILD_LOCATION}/forge-dpu.deb",
]

[tasks.setup-apt-repo]
category = "iPXE Kernel"
description = "Setup apt repo for forge-dpu package"
script = '''
	mv "${REPO_ROOT}/bluefield/forge-dpu_${DPU_AGENT_PKG_VERSION}.deb" \
	"${REPO_ROOT}/pxe/static/blobs/internal/apt/pool/base/f/forge-dpu/"
	cd "${REPO_ROOT}/pxe/static/blobs/internal/apt"
	dpkg-scanpackages -m pool > dists/focal/main/binary-arm64/Packages
	cd "${REPO_ROOT}/pxe/static/blobs/internal/apt/dists/focal"
	echo "Origin: Ubuntu
Label: Ubuntu
Suite: focal
Version: 20.04
Codename: focal
Architectures: arm64
Components: main
Description: Forge apt repo" > Release
	echo "Date: `LANG=C date -Ru`" >> Release
	echo 'SHA256:' >> Release
	find main -type f | xargs -i sh -c 'printf " "$(sha256sum {} | cut -d " " -f 1)" "$(wc --bytes {} | cut -d " " -f 1)" "{}"\n"' >> Release
	cd "${REPO_ROOT}/pxe/static/blobs/internal/apt/dists/focal/main/binary-arm64"
	echo "Archive: focal
Version: 20.04
Component: main
Origin: Ubuntu
Label: Ubuntu
Architecture: arm64" > Release
'''


[tasks.setup-firmware-repo]
category = "iPXE Kernel"
dependencies = ["mkdir-static-x86_64"]
description = "Download vendor specific firmware packages"
script = [
  "echo Downloading nvidia firmware",
  "mkdir -p nvidia/dpu",
  "cd nvidia/dpu",
  "wget -nv \"${BF3_PREINGESTION_BMC_PACKAGE}\"",
]
cwd = "${REPO_ROOT}/pxe/static/blobs/internal/firmware"

[tasks.bfb-copy-efi]
category = "iPXE Kernel"
description = "Copy the BFB efi kernel on aarch64 gitlab runner"
command = "cp"
args = ["/tmp/bfb-dump/dump-image-v0", "carbide.efi"]
cwd = "static/blobs/internal/aarch64"

[tasks.bfb-remove-extracted-efi]
category = "iPXE Kernel"
description = "Remove the BFB efi kernel on aarch64 gitlab runner"
command = "rm"
args = ["-fr", "${BUILD_LOCATION}/dump-image-v0"]

[tasks.bfb-rebuild-rootfs]
category = "iPXE Kernel"
description = "Rebuild the BFB root fs on aarch64 gitlab runner"
script = '''
    echo "Pipeline source is $CI_PIPELINE_SOURCE"
    if [ "$CI_PIPELINE_SOURCE" = "merge_request_event" ] ;then
      echo "Rebuilding BFB with fast compression"
      find . -print0 | cpio --null -o --format=newc | gzip -1 > ../dump-initramfs-v0
    else
      echo "Rebuilding BFB with best compression"
      find . -print0 | cpio --null -o --format=newc | gzip -9 > ../dump-initramfs-v0
    fi
'''
cwd = "${BUILD_LOCATION}"

[tasks.bfb-copy-rootfs]
category = "iPXE Kernel"
description = "Copy the BFB root fs on aarch64 gitlab runner"
command = "cp"
args = ["/tmp/bfb-dump/dump-initramfs-v0", "carbide.root"]
cwd = "static/blobs/internal/aarch64"

[tasks.container-boot-artifacts-x86_64-ci]
category = "iPXE Kernel"
description = "Pacakge x86_64 EFI ipxe kernel and rootdisk"
command = "docker"
args = [
  "-t",
  "boot-artifacts-prod-x86_64:${CI_JOB_ID}",
  "-f",
  "${CI_PROJECT_DIR}/pxe/Dockerfile",
  "${CI_PROJECT_DIR}/pxe",
]

[tasks.container-boot-artifacts-aarch64-ci]
category = "iPXE Kernel"
description = "Pacakge aarch64 EFI ipxe kernel and rootdisk"
command = "docker"
args = [
  "-t",
  "boot-artifacts-prod-aarch64:${CI_JOB_ID}",
  "-f",
  "${CI_PROJECT_DIR}/pxe/Dockerfile",
  "${CI_PROJECT_DIR}/pxe",
]

[tasks.replace-bfpxe-script]
category = "iPXE Kernel"
description = "Switch bfpxe script from bfb to custom one"
command = "cp"
args = ["${REPO_ROOT}/pxe/bfpxe", "${BUILD_LOCATION}/usr/bin/bfpxe"]
