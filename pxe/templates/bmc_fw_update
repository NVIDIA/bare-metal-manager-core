BMC_PASSWORD="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 4)-$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 4)_$(tr -dc '0-9' </dev/urandom | head -c 2)$(tr -dc 'a-z' </dev/urandom | head -c 1)$(tr -dc 'A-Z' </dev/urandom | head -c 1)"
BMC_USER="firmware_updater"
USER_ID=8

pre_bmc_components_update() {
    set -exE
    run_with_timeout "ipmitool user set name $USER_ID $BMC_USER"
    run_with_timeout "ipmitool user set password $USER_ID $BMC_PASSWORD" "ipmitool user set password $USER_ID REDACTED"
    run_with_timeout "ipmitool user enable $USER_ID"
    run_with_timeout "ipmitool channel setaccess 1 $USER_ID ipmi=on"
    run_with_timeout "ipmitool user priv $USER_ID 0x4 1"
    set +exE
}

run_with_timeout() {
  local cmd="$1"
  local printcmd="$2"

  for i in {1..10}; do
    if [ -n "$printcmd" ]; then
      ilog "Running with timeout: $printcmd"
    else
      ilog "Running with timeout: $cmd"
    fi

    timeout 30s $cmd && break || ilog "Attempt $i failed, retrying..."
  done
}

remove_bmc_user() {
    set -exE
    tee data.json <<DOF
    {
        "CertificateString": "$(openssl x509 -inform der -outform pem -in /mnt/lib/firmware/mellanox/boot/capsule/certs/prod/db.cer | sed -e 's/[[:space:]]*$//' -e 's/$/\\n/')",
        "CertificateType": "PEM"
    }
DOF
    # Calling a method defined in the upstream installer with no guarantee itll stay that same name, but it should have
    # already been called during firmware update, this is just to be sure
    # https://github.com/Mellanox/bfb-build/blob/9e80eb358e7bb9e62328039745cc43d69eefc64a/common/install.env/bmc#L118
    create_vlan
    num_certs=$(curl --verbose --insecure --retry 5 --retry-all-errors --user $BMC_USER:$BMC_PASSWORD https://$BMC_IP/redfish/v1/Systems/Bluefield/SecureBoot/SecureBootDatabases/db/Certificates | jq -r ' .Members' | grep odata.id | wc -l)
    ilog "Found the following number of certs in the certdb - $num_certs"
    if [ -z "${num_certs}" ] || [ "${num_certs}" -eq "0" ]; then
        # only run the call if there are no existing certs, otherwise it could cause subsequent installs of the DPU to fail
        # https://nvbugswb.nvidia.com/NvBugs5/SWBug.aspx?bugid=5334987
        curl --verbose --insecure --retry 5 --retry-all-errors --user $BMC_USER:$BMC_PASSWORD -d @data.json https://$BMC_IP/redfish/v1/Systems/Bluefield/SecureBoot/SecureBootDatabases/db/Certificates
    fi
    curl --verbose --insecure --retry 5 --retry-all-errors --user $BMC_USER:$BMC_PASSWORD -X DELETE https://$BMC_IP/redfish/v1/AccountService/Accounts/$BMC_USER
    set +exE
}

bfb_post_install() {
    # this command moves when we reboot the bmc to the end of the installation, hopefully capturing more of the logs we need
    if [[ "$BMC_FIRMWARE_UPDATED" == "yes" ]]; then
        bmc_reboot
    fi
    # move this to after the post install commands
    remove_bmc_user
}
