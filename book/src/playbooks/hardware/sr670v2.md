# Lenovo SR 670 V2

The Lenovo SR670 V2 is the GPU system deployed in the majority of the Azure Colo sites including:

* Phase 1: AZ\[01-06], AZ\[20-33]
* Phase 2a: AZ40, AZ50, AZ60

-----

## Helpful Links

* [Maintenanace Manual](https://pubs.lenovo.com/sr670-v2/SR670V2_maintenance_manual.pdf)
* [Driver Downloads](https://datacentersupport.lenovo.com/us/en/products/servers/thinksystem/sr670v2/downloads/driver-list)
* [Product Guide](https://lenovopress.lenovo.com/lp1393.pdf)
* [Lenovo Knowledge Transfer](https://drive.google.com/drive/u/1/folders/1iixkyIMrfw5Y6JNFq5yaAMyd7vM84pVD)

-----

## Updating Firmware

Lenovo servers can be finicky about updates so when doing firmware updates follow this advice:

* **Always update XCC before UEFI.** You can go from any version to the latest in one go.
* **Always update UEFI while the system is powered off**
* If updating from an old version due to MB replacement:
  * If below 1.51, update to 1.51 first
  * Then update to 2.10. This isn't technically required as far as the documentation is concerned,
  but Lenovo seems to think that it can cause DXE INIT issues if you go directly from 1.51 to 3.xx,
  so we do this extra step. You will need to boot the system so it can apply the firmware before proceeding to
  3.xx versions.
  * Then update to current site build version, which is 2.60 currently

### Firmware Downloads

| | |
|---|---|
| XCC 4.14 | lnvgy\_fw\_xcc\_tgbt52f-4.14\_anyos\_noarch.uxz [https://datacentersupport.lenovo.com/tw/en/downloads/DS571801](https://datacentersupport.lenovo.com/tw/en/downloads/DS571801) |
| UEFI 2.60 | lnvgy\_fw\_uefi\_u8e128n-2.60\_anyos\_32-64.uxz [https://datacentersupport.lenovo.com/tw/en/downloads/DS572282](https://datacentersupport.lenovo.com/tw/en/downloads/DS572282) |
| UEFI 1.51 (prereq for 2.xx) | lnvgy\_fw\_uefi\_u8e122j-1.51\_anyos\_32-64.uxz [https://datacentersupport.lenovo.com/us/en/downloads/DS562960](https://datacentersupport.lenovo.com/us/en/downloads/DS562960) |

#### ONECLI FIRMWARE UPDATE

```bash
~/onecli/onecli update scan --log 5 --bmc $USER:$HOSTBMCPW@$HOSTBMCIP
[1s]Certificate check finished [100%][=====================================================================>]
[6s]Scanning finished. [100%][=============================================================================>]

           Platform Information:
    ==================================
    | Machine Type | BMC Type |  OS  |
    ----------------------------------
    | 7Z23         | XCC      | None |
    ==================================

                              Scan Result:
    ===============================================================
    | No. |    Updatable Unit    |    Slot    | Installed Version |
    ---------------------------------------------------------------
    | 1   | BMC (Primary)        | N/A        | TGBT26F-1.60      |
    ---------------------------------------------------------------
    | 2   | BMC (Backup)         | N/A        | TGBT26F-1.60      |
    ---------------------------------------------------------------
    | 3   | UEFI                 | N/A        | U8E114E-1.10      |
    ---------------------------------------------------------------
    | 4   | LXPM                 | N/A        | *-* |
    ---------------------------------------------------------------
    | 5   | LXPM Windows Drivers | N/A        | *-* |
    ---------------------------------------------------------------
    | 6   | LXPM Linux Drivers   | N/A        | *-* |
    ---------------------------------------------------------------
    | 7   | POWER-PSU1           | PSU_Slot 1 | 7.52              |
    ---------------------------------------------------------------
    | 8   | POWER-PSU2           | PSU_Slot 2 | 7.52              |
    ---------------------------------------------------------------
    | 9   | POWER-PSU3           | PSU_Slot 3 | 7.52              |
    ---------------------------------------------------------------
    | 10  | POWER-PSU4           | PSU_Slot 4 | 7.52              |
    ===============================================================
Scan results saved to: /home/apatten/tmp/lenovo/logs/OneCli-20250626-162657-2786767/Onecli-update-scan.xml
Succeed.

~/onecli/onecli update acquire --mt 7Z23 --scope latest --type fw --ostype none --dir 7Z23 --output ./logs
# <downloads a bunch of stuff - You wil want to winnow it down to the basics, UEFI, XCC and LXPM #

~/onecli/onecli update compare --scope latest --dir 7Z23/ --output ./logs --bmc $USER:$HOSTBMCPW@$HOSTBMCIP
[1s]Certificate check finished [100%][=====================================================================>]
[4s]Scanning finished. [100%][=============================================================================>]

           Platform Information:
    ==================================
    | Machine Type | BMC Type |  OS  |
    ----------------------------------
    | 7Z23         | XCC      | None |
    ==================================

                              Scan Result:
    ===============================================================
    | No. |    Updatable Unit    |    Slot    | Installed Version |
    ---------------------------------------------------------------
    | 1   | BMC (Primary)        | N/A        | TGBT26F-1.60      |
    ---------------------------------------------------------------
    | 2   | BMC (Backup)         | N/A        | TGBT26F-1.60      |
    ---------------------------------------------------------------
    | 3   | UEFI                 | N/A        | U8E114E-1.10      |
    ---------------------------------------------------------------
    | 4   | LXPM                 | N/A        | *-* |
    ---------------------------------------------------------------
    | 5   | LXPM Windows Drivers | N/A        | *-* |
    ---------------------------------------------------------------
    | 6   | LXPM Linux Drivers   | N/A        | *-* |
    ---------------------------------------------------------------
    | 7   | POWER-PSU1           | PSU_Slot 1 | 7.52              |
    ---------------------------------------------------------------
    | 8   | POWER-PSU2           | PSU_Slot 2 | 7.52              |
    ---------------------------------------------------------------
    | 9   | POWER-PSU3           | PSU_Slot 3 | 7.52              |
    ---------------------------------------------------------------
    | 10  | POWER-PSU4           | PSU_Slot 4 | 7.52              |
    ===============================================================
Scan results saved to: /home/apatten/tmp/lenovo/./logs/Onecli-update-scan.xml
Querying updates done, the result is stored to /home/apatten/tmp/lenovo/./logs/Onecli-update-query.xml

                                                          Comparing Updates:
    =============================================================================================================================
    | No. | Updatable Unit | Slot |   New Version   | Installed Version | Selected |                 Update ID                  |
    -----------------------------------------------------------------------------------------------------------------------------
    | 1   | UEFI           | N/A  | U8E112A-1.02    | U8E114E-1.10      | No (*20) | lnvgy_fw_uefi_u8e112a-1.02_anyos_32-64     |
    -----------------------------------------------------------------------------------------------------------------------------
    | 2   | UEFI           | N/A  | u8e132e-3.20    | U8E114E-1.10      | No (*9)  | lnvgy_fw_uefi_u8e132e-3.20_anyos_32-64     |
    -----------------------------------------------------------------------------------------------------------------------------
    | 3   | LXPM           | N/A  | xwl128g-3.31.00 | *-* | YES      | lnvgy_fw_lxpm_xwl128g-3.31.00_anyos_noarch |
    -----------------------------------------------------------------------------------------------------------------------------
    | 4   | BMC (Primary)  | N/A  | tgbt56d-5.10    | TGBT26F-1.60      | YES      | lnvgy_fw_xcc_tgbt56d-5.10_anyos_noarch     |
    -----------------------------------------------------------------------------------------------------------------------------
    | 5   | UEFI           | N/A  | u8e122h-1.50    | U8E114E-1.10      | YES      | lnvgy_fw_uefi_u8e122h-1.50_anyos_32-64     |
    =============================================================================================================================
    *20-This is prerequisite of another package and the installed version is met the requirement
    *9-The requisite packages do not exist

Compare updates done, the result is stored to /home/apatten/tmp/lenovo/./logs/Onecli-update-compare.xml
Succeed.

~/onecli/onecli update flash --comparexml /home/apatten/tmp/lenovo/./logs/Onecli-update-compare.xml --dir 7Z23/ \
--output ./logs --bmc $USER:$HOSTBMCPW@$HOSTBMCIP
[1s]Certificate check finished [100%][=====================================================================>]

Start OOB flashing...

Current flashing ID:lnvgy_fw_lxpm_xwl128g-3.31.00_anyos_noarch

[2s]Uploading succeed [100%][==============================================================================>]

[20s]Task Completed [100%][================================================================================>]

Current flashing ID:lnvgy_fw_xcc_tgbt56d-5.10_anyos_noarch

[52s]Uploading succeed [100%][=============================================================================>]

[1m6s]Task Completed [100%][===============================================================================>]
[4m53s]Succeed to Reboot BMC. [100%][======================================================================>]

Current flashing ID:lnvgy_fw_uefi_u8e122h-1.50_anyos_32-64

[8s]Uploading succeed [100%][==============================================================================>]

[3m7s]Task Completed [100%][===============================================================================>]

                                                   Flash Results:
    ===========================================================================================================
    | No. | Updatable Unit | Slot | Activation Status  | Result  |                 Update ID                  |
    -----------------------------------------------------------------------------------------------------------
    | 1   | LXPM           | N/A  | Activated          | success | lnvgy_fw_lxpm_xwl128g-3.31.00_anyos_noarch |
    -----------------------------------------------------------------------------------------------------------
    | 2   | BMC (Primary)  | N/A  | Activated          | success | lnvgy_fw_xcc_tgbt56d-5.10_anyos_noarch     |
    -----------------------------------------------------------------------------------------------------------
    | 3   | UEFI           | N/A  | Pending restart OS | success | lnvgy_fw_uefi_u8e122h-1.50_anyos_32-64     |
    ===========================================================================================================
Package statistic results:
3 package(s) attempted
3 package(s) succeeded

Updatable Unit statistic results:
3 update(s) attempted
3 update(s) succeeded

Succeeded in running flash command
```

-----

## Internal Cabling

By far, the largest issue with the SR670 V2 has to do with issues related to internal cabling. 
Due to the flexible nature of the server there are MANY ways to cable the GPUs and risers in the system.

Symptoms of incorrect cabling can include:

* System hang at DXE INIT
* Missing PCIe devices
* PCIe Conn X has encountered a configuration error

The following graphic shows how the data cables should route in the system.

<figure>
<img src=../../static/playbooks/hardware/sr670v2_config38_cabling.png
alt="SR670 V2 MCIO cable routing">
</figure>

More details can be found in the maintenance manual. The SR 670 V2 configuration we use is the
"**8-DW GPU Model cable routing; Configuration J**" variety which is found starting on page 121 of the
maintenance manual. **I would highly recommend that when dealing with issues that may be related to cabling,
that you provide both the graphic showing the high level system connectivity as well as a link to the maintenance
manual stating they should carefully validate the cabling as shown on pages 121 - 126 for the drive backplane,
GPU distribution boards, rear riser and onboard Ethernet components.**

### Backplane

<figure>
<img src=../../static/playbooks/hardware/sr670v2_drive_backplane_cabling.png
alt="SR670 V2 drive backplane cable routing">
</figure>

### GPU Distribution Board

<figure>
<img src=../../static/playbooks/hardware/sr670v2_gpu_cabling_1.png
alt="SR670 V2 MCIO GPU cable routing">
</figure>
<figure>
<img src=../../static/playbooks/hardware/sr670v2_gpu_cabling_2.png
alt="SR670 V2 MCIO GPU cable routing">
</figure>

### Rear Riser

<figure>
<img src=../../static/playbooks/hardware/sr670v2_riser_cabling.png
alt="SR670 V2 PCIe riser cable routing">
</figure>

### OCP Ethernet Adapter

<figure>
<img src=../../static/playbooks/hardware/sr670v2_ocp_cable.png
alt="SR670 V2 OCP ethernet cable routing">
</figure>
