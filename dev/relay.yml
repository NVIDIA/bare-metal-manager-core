#cloud-config
packages:
  - dnsmasq
  - nftables

write_files:
  - path: "/etc/dnsmasq.conf"
    permissions: "0644"
    content: |
      port=0
      interface=enp0s9
      dhcp-range=192.168.0.50,192.168.0.150,12h
      
      dhcp-boot=undionly.kpxe
      dhcp-match=set:ipxe,175 # iPXE sends a 175 option.
      dhcp-boot=tag:ipxe,http://172.16.0.110:8000/api/v0/pxe
      
      dhcp-match=amd64bios,option:client-arch, 0  # BIOS x86-64
      dhcp-match=amd64efi, option:client-arch, 6  # EFI x86-64
      dhcp-match=amd64efi, option:client-arch, 7  # EFI x86-64
      dhcp-match=arm64efi, option:client-arch, 11 # EFI ARM64
      
      enable-tftp
      tftp-root=/var/ftpd
      tftp-no-fail
      dhcp-authoritative
      # TODO - integrate with carbide later?
      #dhcp-script=/bin/echo
      no-negcache
    owner: "root:root"
  - path: "/etc/sysctl.d/90-forwarding.conf"
    permissions: "0644"
    content: |
      net.ipv4.ip_forward=1
      net.ipv6.conf.all.forwarding=1
    owner: root:root

runcmd:
  - [ systemctl, daemon-reload ]
  - [ systemctl, restart, dnsmasq ]
  - /usr/sbin/nft add table nat
  - /usr/sbin/nft add chain nat postrouting '{ type nat hook postrouting priority 100; }'
  - /usr/sbin/nft add rule nat postrouting masquerade
  - [ systemctl, restart, procps ]
