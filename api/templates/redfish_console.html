{% extends "base.html" %}

{% block title %}Redfish Console{% endblock %}

{% block content %}
<h1>Redfish Console</h1>

<p>
This page allows to send queries to BMCs managed by Forge.
Enter a valid redfish URL below to send a query and display the response.
The query needs to be fully qualified - e.g. <b>https://127.0.0.1/redfish/v1</b>.
</p>

<p>
<b>ðŸš§ Note that due to implementation limitations, the page can currently only endpoints
	for ingested machines - which means a Machine entry needs to exist for the endpoint.
</b>
</p>

<form id="redfish_console" method="GET" action="/admin/redfish-console">
	<label for="ref">URL to query:</label><input type=text id="ref" name="url" value="{{ url }}" />
	<input type="submit" value="Start query">
</form>

{% if !url.is_empty() %}

<h3>Metadata</h3>
<table class="detailsview">
	<tr><th>BMC IP</th><td>{{ bmc_ip }}</td></tr>
	<tr><th>Machine ID</th><td>{{ machine_id|machine_id_link|safe }}</td></tr>
	<tr><th>HTTP status</th><td>{{ status_code }} {{ status_string }}</td></tr>
</table>

{% if !error.is_empty() %}
<h3>Error</h3>
<textarea disabled style="width: 100%">{{ error }}</textarea>
{% endif %}

{% if !response.is_empty() %}
<h3>Response</h3>
<div style="overflow: auto;">
	<pre style="width: 100%;"><code class="bmcresponse">{{ response }}</code></pre>
</div>
{% endif %}

{% endif %}

{% endblock %}

{% block script %}

const baseBmcUrl = "{{ base_bmc_url }}";

function formatBmcResponse() {
	let elems = document.getElementsByClassName("bmcresponse");
	const re = /(?<="@odata.id":\s*")[^"]*(?=")/g;

	for (elem of elems) {
		// Pretty print response in case its JSON. This also helps
		// with the follow-up step
		if (elem.parentElement.nodeName === "PRE") {
			elem.parentElement.style.whiteSpace = "pre-wrap";
		}
		try {
			let jsObj = JSON.parse(elem.innerText);
			elem.innerText = JSON.stringify(jsObj, null,4);
		} catch (e) {
		}

		// For each @odata.id element that is found, generate a link
		try {
			let html = elem.innerHTML.replaceAll(re, path => {
				let encodedQueryPath = encodeURIComponent(baseBmcUrl + path);
				return `<a href="/admin/redfish-console?url=${encodedQueryPath}">${path}</a>`;
			});
			elem.innerHTML = html;
		} catch (e) {
		}
	}
}

document.addEventListener("DOMContentLoaded", function(event){
	formatBmcResponse();
});

{% endblock %}
