{% extends "base.html" %}

{% block title %}{{ id }}{% endblock %}

{% block content %}
<h1>{{ machine_type }} {{ id }}</h1>

<table class="detailsview">
	<tr>
		<th>Managed Host</th>
		<td>
		{% if !is_host %}
			{{ host_id|managed_host_id_link|safe }}
		{% else %}
			{{ id|managed_host_id_link|safe }}
		{% endif %}
		</td>
	</tr>
	<tr><th>State</th><td>{{ state }}</td></tr>
	<tr><th>State Version</th><td>{{ state_version|config_version|safe }}</td></tr>
	<tr><th>Time in state</th><td>{{ time_in_state }}</td></tr>
	<tr><th>Last Reboot</th><td>{{ last_reboot }}</td></tr>
	<tr><th>State SLA</th><td>{{ state_sla }}</td></tr>
	<tr><th>Time in State is above SLA</th><td>{{ time_in_state_above_sla }}</td></tr>
	{% if !state_reason.is_empty() %}
	<tr><th>State machine is blocked</th><td>{{ state_reason }}</td></tr>
	{% endif %}

	{% if !network_config.is_empty() %}
	<tr>
		<th>Network config (sent to forge-dpu-agent)</th>
		<td><div style="max-height: 20vh; overflow: auto; margin: 0; padding: 0;"><pre><code>{{ network_config }}</code></pre></div></td>
	</tr>
	{% endif %}
	<tr><th>Version</th><td>{{ version }}</td></tr>
</table>

<h3>Metadata</h3>
<table class="detailsview">
	<tr><th>Name</th><td>{{ metadata.name }}</td></tr>
	<tr><th>Description</th><td>{{ metadata.description }}</td></tr>
	<tr><th>Labels</th><td>{{ metadata.labels|label_list_fmt(false)|safe }}</td></tr>
</table>

<h3>Health</h3>
<table class="detailsview">
	<tr><th>Health Reports</th>
		<td>
			{% if !is_host %}
				<a href="/admin/machine/health/{{ host_id }}">Go to ManagedHost health reports</a>
			{% else %}
				<a href="/admin/machine/health/{{ id }}">Go to ManagedHost health reports</a>
			{% endif %}
		</td>
	</tr>
	<tr><th>Report Source</th><td>{{ health.source }}</td></tr>
	<tr><th>Report Observed At</th><td>{{ health.observed_at|option_fmt }}</td></tr>
	<tr>
		<th>Health Probe Alerts</th>
		<td>
			{% if health.alerts.len() == 0 %}<div class="healthy">{% else %}<div class="unhealthy">{% endif %}
			<a href="/admin/machine/health/{{ id }}">
				{{ health.alerts|health_alerts_fmt(true)|safe }}
			</a>
			</div>
		</td>
	</tr>
	<tr>
		<th>Health Alert Classifications</th>
		<td>{{ health.alerts|health_alert_classifications_fmt|safe }}</td>
	</tr>
	<tr>
		<th>Health Overrides</th>
		<td>
			<a href="/admin/machine/health/{{ id }}">
				{{ health_overrides|join("\n")|linebreaksbr|safe }}
			</a>
		</td>
	</tr>
</table>

<h3>BMC</h3>
{% match bmc_info %}
{% when Some with (bmc_info) %}
{% set bmc_ip = bmc_info.ip.clone().unwrap_or_default() %}
<table class="detailsview">
	<tr><th>IP</th><td><a href="/admin/explored-endpoint/{{ bmc_ip }}">{{ bmc_ip }}</a></td></tr>
	<tr><th>Port</th><td>{{ bmc_info.port|option_fmt }}</td></tr>
	<tr><th>MAC Address</th><td>{{ bmc_info.mac|option_fmt }}</td></tr>
	<tr><th>Version</th><td>{{ bmc_info.version|option_fmt }}</td></tr>
	<tr><th>Firmware Version</th><td>{{ bmc_info.firmware_version|option_fmt }}</td></tr>
	<tr>
		<th>Power Control</th>
		<td>
			{% include "power_control.html" %}
		</td>
	</tr>
	<tr>
		<th>Reset BMC</th>
		<td>
			{% include "bmc_reset.html" %}
		</td>
	</tr>
</table>
{% else %}
Missing BMC Data
{% endmatch %}

<h3>Discovery Info</h3>
<table class="detailsview">
	<tr><th>Sys Vendor</th><td>{{ sys_vendor }}</td></tr>
	<tr><th>Product Name</th><td>{{ product_name }}</td></tr>
	<tr><th>Product Serial</th><td>{{ product_serial }}</td></tr>
	<tr><th>Chassis Serial</th><td>{{ chassis_serial }}</td></tr>
	<tr><th>Board Serial</th><td>{{ board_serial }}</td></tr>
	<tr><th>Bios Version</th><td>{{ bios_version }}</td></tr>
	<tr><th>Board Version</th><td>{{ board_version }}</td></tr>
	<tr>
		<th>Full Report</th>
		<td>
			<details>
				<summary>Expand Report</summary>
				<div style="max-height: 40vh; overflow: auto; margin: 0; padding: 0;">
					<pre><code>{{ discovery_info_json }}</code></pre>
				</div>
			</details>
		</td>
	</tr>
</table>

<h3>Interfaces</h3>
{% for interface in interfaces %}
<table class="detailsview">
	<tr><th>Index</th><td>{{ interface.index }}</td></tr>
	<tr><th>ID</th><td><a href="/admin/interface/{{ interface.id }}">{{ interface.id }}</a></td></tr>
	{% if is_host %}
		<tr><th>DPU ID</th><td>{{ interface.dpu_id|machine_id_link|safe }}</td></tr>
	{% endif %}
	<tr><th>Segment ID</th><td><a href="/admin/network-segment/{{ interface.segment_id }}">{{ interface.segment_id }}</a></td></tr>
	<tr><th>Domain ID</th><td>{{ interface.domain_id }}</td></tr>
	<tr><th>Hostname </th><td>{{ interface.hostname }}</td></tr>
	<tr><th>Primary</th><td>{{ interface.primary }}</td></tr>
	<tr><th>MAC Address</th><td>{{ interface.mac_address }}</td></tr>
	<tr><th>Addresses</th><td>{{ interface.addresses }}</td></tr>
</table>
{% endfor %}

{% if is_host %}
<h3>InfiniBand Interfaces</h3>
<table class="detailsview">
	<thead>
		<tr>
			<th>Device</th>
			<th>Vendor</th>
			<th>GUID</th>
			<th>Slot</th>
			<th>LID</th>
			<th>Visible from UFM</th>
		</tr>
	</thead>
	<tbody>
	{% for interface in ib_interfaces %}
		<tr>
			<td>{{ interface.device }}</td>
			<td>{{ interface.vendor }}</td>
			<td>{{ interface.guid }}</td>
			<td>{{ interface.slot }}</td>
			<td>{{ interface.lid }}</td>
			{% if interface.ufm_visible == "false" %}
			<td style="background-color: red">
			{% else if interface.ufm_visible == "unknown" %}
			<td style="background-color: yellow">
			{% else %}
			<td>
			{% endif %}
			{{ interface.ufm_visible }}
			</td>
		</tr>
	{% endfor %}
	</tbody>
</table>
{% endif %}

<h3>Inventory</h3>
<table class="detailsview">
	<thead>
		<tr>
			<th>Name</th>
			<th>Version</th>
			<th>URL</th>
		</tr>
	</thead>
	<tbody>
	{% for item in inventory %}
		<tr>
			<td>{{ item.name }}</td>
			<td>{{ item.version }}</td>
			<td>{{ item.url }}</td>
		</tr>
	{% endfor %}
	</tbody>
</table>

<h3>Capabilities</h3>
<table class="detailsview">
	<thead>
		<tr>
			<th>Type</th>
			<th>Name</th>
			<th>Count</th>
		</tr>
	</thead>
	<tbody>
	{% for cap in capabilities %}
		<tr>
			<td>{{ cap.ty }}</td>
			<td>{{ cap.name }}</td>
			<td>{{ cap.count }}</td>
		</tr>
	{% endfor %}
	</tbody>
</table>

<h3>Capability Details</h3>
<table class="detailsview">
	<tr>
		<th>Full Capabilities</th>
		<td>
			<details>
				<summary>Expand Capabilities</summary>
				<div style="max-height: 40vh; overflow: auto; margin: 0; padding: 0;">
					<pre><code>{{ capabilities_json }}</code></pre>
				</div>
			</details>
		</td>
	</tr>
</table>


<h3>History</h3>
<table class="detailsview">
	<thead>
		<tr>
			<th>Version</th>
			<th>State</th>
		</tr>
	</thead>
	<tbody>
	{% for event in history %}
		<tr>
			<td>{{event.version|config_version|safe}}</td>
			<td style="overflow: auto;"><pre style="max-width: 50vw;"><code class="prettyjson">{{event.event}}</code></pre></td>
		</tr>
	{% endfor %}
	</tbody>
</table>

{% endblock %}
