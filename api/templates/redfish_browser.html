{% extends "base.html" %}

{% block title %}Redfish Browser{% endblock %}

{% block content %}
<h1>Redfish Browser</h1>

<p>
This page allows to send queries to BMCs managed by Forge.
Enter a valid redfish URL below to send a query and display the response.
The query needs to be fully qualified - e.g. <b>https://127.0.0.1/redfish/v1</b>.
</p>

<form id="redfish_console" method="GET" action="/admin/redfish-browser">
	<input type=text size="80" id="url_input" name="url" placeholder="https://127.0.0.1/redfish/v1" value="{{ url }}" />
	<input type="submit" value="Start query">
</form>

{% if !url.is_empty() %}

<h3>Metadata</h3>
<table class="detailsview">
	<tr><th>BMC IP</th><td>{{ bmc_ip }}</td></tr>
	<tr><th>Machine ID</th><td>{{ machine_id|machine_id_link|safe }}</td></tr>
	<tr><th>HTTP status</th><td>{{ status_code }} {{ status_string }}</td></tr>
	{% if !response_headers.is_empty() %}
	<tr>
		<th>Response Headers</th>
		<td>
			<details>
				<summary>Expand Headers</summary>
				<table class="detailsview">
					{% for header in response_headers %}
					<tr>
						<td>{{ header.name }}</td>
						<td>{{ header.value }}</td>
					</tr>
					{% endfor %}
				</table>
			</details>
		</td>
	</tr>
	{% endif %}
</table>

{% if !error.is_empty() %}
<h3>Error</h3>
<textarea disabled>{{ error }}</textarea>
{% endif %}

{% if !response.is_empty() %}
<h3>Response</h3>
<table class="detailsview">
<tbody>
	<tr>
		<td>
			<div style="overflow: auto;">
				<pre><code class="bmcresponse">{{ response }}</code></pre>
			</div>
		</td>
	</tr>
</tbody>
</table>
{% endif %}

{% endif %}

{% endblock %}

{% block script %}

const baseBmcUrl = "{{ base_bmc_url }}";

function formatBmcResponse() {
	let elems = document.getElementsByClassName("bmcresponse");
	const re = /(?<="@odata.id":\s*")[^"]*(?=")/g;

	for (elem of elems) {
		// Pretty print response in case its JSON. This also helps
		// with the follow-up step
		try {
			let jsObj = JSON.parse(elem.innerText);
			elem.innerText = JSON.stringify(jsObj, null,4);
		} catch (e) {
		}

		// For each @odata.id element that is found, generate a link
		try {
			let html = elem.innerHTML.replaceAll(re, path => {
				let encodedQueryPath = encodeURIComponent(baseBmcUrl + path);
				return `<a href="/admin/redfish-browser?url=${encodedQueryPath}">${path}</a>`;
			});
			elem.innerHTML = html;
		} catch (e) {
		}
	}
}

document.addEventListener("DOMContentLoaded", function(event){
	formatBmcResponse();
});

{% endblock %}
