{% extends "base.html" %}

{% block title %}Managed Host{% endblock %}

{% block content %}
<h1>Managed Host {{ machine_id }}</h1>
<table>
	<tr><th>State</th><td>{{ state }}</td></tr>
	<tr><th>Time in state</th><td>{{ time_in_state }}</td></tr>
	{% if !state_reason.is_empty() %}
	<tr><th>State machine is blocked</th><td>{{ state_reason }}</td></tr>
	{% endif %}
	{% if !maintenance_reference.is_empty() %}
	<tr>
      <th>Maintenance Reference</th>
      <td>{% if is_link_ref %}<a href="{{ maintenance_reference }}">{{ maintenance_reference }}</a>{% else %}{{ maintenance_reference }}{% endif %}</td>
    </tr>
		<tr><th>Maintenance Start</th><td>{{ maintenance_start_time }}</td></tr>
	{% endif %}
	<tr>
		<th>Maintenance Action</th>
		<td>
			<form id="maintenance_action" method="POST" action="/admin/managed-host/{{ machine_id }}/maintenance">
				{% if maintenance_reference.is_empty() %}
					<input type="hidden" name="action" value="enter"/>
					<label for="ref">Reference:</label><input type=text id="ref" name="reference" />
					<button type="submit">Enter maintenance</button>
					<p>Machines in maintenance mode cannot be assigned an instance</p>
				{% else %}
					<input type="hidden" name="action" value="exit"/>
					<button style="margin-left: 0" type="submit">Exit maintenance</button>
				{% endif %}
			</form>
		</td>
	</tr>
</table>

<h2>Health</h2>
<table>
	<tr><th>Report Source</th><td>{{ health.source }}</td></tr>
	<tr><th>Report Observed At</th><td>{% match health.observed_at %}{% when Some with (observed_at) %} {{ observed_at }} {% else %}{% endmatch %}</td></tr>
	<tr>
		<th>Health Probe Alerts</th>
		<td>
			{% if health.alerts.len() == 0 %}<div class="healthy">{% else %}<div class="unhealthy">{% endif %}
			<a href="/admin/machine/health/{{ machine_id }}">
				{{ health.alerts|health_alerts_fmt|safe }}
			</a>
			</div>
		</td>
	</tr>
	<tr>
		<th>Health Alert Classifications</th>
		<td>{{ health.alerts|health_alert_classifications_fmt|safe }}</td>
	</tr>
	<tr>
		<th>Health Overrides</th>
		<td>
			<a href="/admin/machine/health/{{ machine_id }}">
				{{ health_overrides|join("\n")|linebreaksbr|safe }}
			</a>
		</td>
	</tr>
</table>

<h2>Host</h2>

<table>
	<tr><th>ID</th><td>{{ machine_id|machine_id_link|safe }}</td></tr>
	<tr><th>Last reboot</th><td>{{ host_last_reboot_time }}</td></tr>
	<tr><th>Serial Number</th><td>{{ host_serial_number }}</td></tr>
	<tr><th>BIOS Version</th><td>{{ host_bios_version }}</td></tr>
	<tr><th>GPU Count</th><td>{{ host_gpu_count }}</td></tr>
	<tr><th>InfiniBand Interface Count</th><td>{{ host_ib_ifs_count }}</td></tr>
	<tr><th>Memory</th><td>{{ host_memory }}</td></tr>
	<tr><th>Admin IP</th><td>{{ host_admin_ip }}</td></tr>
	<tr><th>Admin MAC</th><td>{{ host_admin_mac }}</td></tr>
	<tr><th>Admin Hostname</th><td>{{ hostname }}</td></tr>
	<tr><th>BMC Version</th><td>{{ host_bmc_version }}</td></tr>
	<tr><th>BMC Firmware Version</th><td>{{ host_bmc_firmware_version }}</td></tr>
	<tr><th>BMC IP</th><td><a href="/admin/explored-endpoint/{{ host_bmc_ip }}">{{ host_bmc_ip }}</a></td></tr>
	<tr><th>BMC MAC</th><td>{{ host_bmc_mac }}</td></tr>
</table>

{% for dpu in dpus %}
<h2>DPU {{loop.index}}</h2>
<table>
	<tr><th>ID</th><td>{{ dpu.machine_id|machine_id_link|safe }}</td></tr>
	<tr><th>Primary</th><td>{{ dpu.is_primary }}</td></tr>
	<tr><th>Healthy</th>
    <td>{% if dpu.is_network_healthy %}Yes{% else %}{{ dpu.network_error_msg.clone().unwrap_or("".to_string()) }}{% endif %}</td>
	<tr><th>Last reboot</th><td>{{ dpu.last_reboot_time }}</td></tr>
	<tr><th>Last seen</th><td>{{ dpu.last_observation_time }}</td></tr>
	<tr><th>Serial Number</th><td>{{ dpu.serial_number }}</td></tr>
	<tr><th>BIOS Version</th><td>{{ dpu.bios_version }}</td></tr>
	<tr><th>Admin IP</th><td>{{ dpu.oob_ip }}</td></tr>
	<tr><th>Admin MAC</th><td>{{ dpu.oob_mac }}</td></tr>
	<tr><th>BMC Version</th><td>{{ dpu.bmc_version }}</td></tr>
	<tr><th>BMC Firmware Version</th><td>{{ dpu.bmc_firmware_version }}</td></tr>
	<tr><th>BMC IP</th><td><a href="/admin/explored-endpoint/{{ dpu.bmc_ip }}">{{ dpu.bmc_ip }}</a></td></tr>
	<tr><th>BMC MAC</th><td>{{ dpu.bmc_mac }}</td></tr>
	<tr><th>Switch Connections</th><td>{{ dpu.switch_connection_details() }}</td></tr>
</table>
{% endfor %}

<script>
	function are_you_sure(event) {
		event.preventDefault();
		let form = document.getElementById("maintenance_action");
		{% if maintenance_reference.is_empty() %}
			if (!document.getElementById("ref").value) {
				alert("Reference is required. It is usually a ticket tracker URL.");
				return;
			}
			let confirm = window.confirm("Take machine out of service and put it into maintenance mode?");
		{% else %}
			let confirm = window.confirm("Put machine back into service, exiting maintenance mode?");
		{% endif %}
		if (confirm) {
			form.removeEventListener("submit", are_you_sure);
			form.submit();
		}
	}
	document.addEventListener("DOMContentLoaded", function(event){
		let form = document.getElementById("maintenance_action");
		form.addEventListener("submit", are_you_sure);
	});
</script>

{% endblock %}
