{% extends "base.html" %}

{% block title %}{{ machine_type }} Health {{ id }}{% endblock %}

{% block content %}
<h1>{{ machine_type }} Health <a href="/admin/machine/{{ id }}">{{ id }}</a></h1>

<details>
	<summary>
		<h2 style="display: inline-block;">Add Override</h2>
	</summary>
	<p>
		<b>Instructions:</b>
		<i><ul>
			<li>Fill out the form below and press the submit button to submit a health override.</li>
			<li>The probe <b>id</b> and <b>message</b> fields need to be populated.</li>
			<li>Probe <b>target</b>s are optional.</li>
			<li>The preset buttons below allow to pre-populate the textbox for certain use-cases.</li>
		</ul></i>
	</p>
	<p>
		<b>Presets:</b>
		<ul>
			<li><input type="submit" value="Blank Example" onclick="setOverrideTextBoxToTemplate(templateHealthReport)"></li>
			<li><input type="submit" value="Host Update (To allow manual DPU Reprovisioning)" onclick="setOverrideTextBoxToTemplate(templateMergeHostUpdateMaintenance)"></li>
			<li><input type="submit" value="Internal Maintenance" onclick="setOverrideTextBoxToTemplate(templateMergeInternalMaintenance)"></li>
			<li><input type="submit" value="Out For Repair Maintenance" onclick="setOverrideTextBoxToTemplate(templateMergeOfrMaintenance)"></li>
			<li><input type="submit" value="Degraded" onclick="setOverrideTextBoxToTemplate(templateMergeDegradedMaintenance)"></li>
			<li><input type="submit" value="Validation" onclick="setOverrideTextBoxToTemplate(templateMergeValidationMaintenance)"></li>
			<li><input type="submit" value="Suppress External Alerting Only" onclick="setOverrideTextBoxToTemplate(templateMergeSuppressExternalAlerting)"></li>
			<li><input type="submit" value="Merge: Alert which prevents allocations" onclick="setOverrideTextBoxToTemplate(templateMergeSingleAlert)"></li>
			<li><input type="submit" value="Replace: Alert which prevents allocations" onclick="setOverrideTextBoxToTemplate(templateReplaceSingleAlert)"></li>
			<li><input type="submit" value="Replace: Mark machine as healthy" onclick="setOverrideTextBoxToTemplate(templateReplaceAsHealthy)"></li>
		</ul>
	</p>
	<textarea id="override" rows="20" style="width: 100%">
	</textarea>
	<p><input type="submit" id="submit_add" value="Submit Override"></p>
</details>

{% if !overrides.is_empty() %}
<h2>Active overrides:</h2>
<table class="sortable detailsview">
<thead>
	<tr>
		<th>Source</th>
		<th>Mode</th>
		<th>Remove</th>
		<th>Alerts</th>
		<th>Details</th>
	</tr>
</thead>
<tbody>
	{% for override in overrides %}
	<tr>
		<td>{{ override.health_report.source }}</td>
		<td>{{ override.mode }}</td>
		<td><input type="button" id="remove-override-{{ override.health_report.source }}" value="Remove"></td>
		<td>{{ override.health_report.alerts|health_alerts_fmt(false)|safe }}</td>
		<td style="overflow: auto;">
			<details>
				<summary><b>Expand</b></summary>
				<pre style="max-width: 50vw;"><code class="prettyjson">{{ override|json|safe }}</code></pre>
			</details>
		</td>
	</tr>
	{% endfor %}
</tbody>
</table>
{% endif %}

{{ aggregate_health|safe }}

<details>
	<summary>
		<h2 style="display: inline-block;">Component Health</h2>
		<br><i>Health of individual components is hidden. Expand for details.</i>
	</summary>
	{% for component in component_health %}
	{{ component|safe }}
	{%endfor%}
</details>

<details open>
	<summary>
		<h2 style="display: inline-block;">History</h2>
		<a href="/admin/machine/{{ id }}/health-history">Open History on separate page</a>
	</summary>
	{{ history|safe }}
</details>

{% endblock %}

{% block script %}

const templateHealthReport = {
	mode: "Merge",
	health_report: {
		source: "carbide-web",
		successes: [{id: "", target: null}],
		alerts: [{id: "", target: null, message: "", tenant_message: null, classifications: [""]}]
	}
};

const templateMergeHostUpdateMaintenance = {
	mode: "Merge",
	health_report: {
		source: "host-update",
		successes: [],
		alerts: [{id: "HostUpdateInProgress", target: "WebUi", message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeInternalMaintenance = {
	mode: "Merge",
	health_report: {
		source: "maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: null, message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeOfrMaintenance = {
	mode: "Merge",
	health_report: {
		source: "manual-maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: "OutForRepair", message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeDegradedMaintenance = {
	mode: "Merge",
	health_report: {
		source: "manual-maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: "Degraded", message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeValidationMaintenance = {
	mode: "Merge",
	health_report: {
		source: "manual-maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: "Validation", message: "", tenant_message: null, classifications: ["SuppressExternalAlerting"]}]
	}
};

const templateMergeSuppressExternalAlerting = {
	mode: "Merge",
	health_report: {
		source: "suppress-paging",
		successes: [],
		alerts: [{id: "SuppressExternalAlerting", target: null, message: "Paging is suppressed for this Host", tenant_message: null, classifications: ["SuppressExternalAlerting"]}]
	}
};

const templateMergeSingleAlert = {
	mode: "Merge",
	health_report: {
		source: "carbide-web",
		successes: [],
		alerts: [{id: "", target: null, message: "", tenant_message: null, classifications: ["PreventAllocations"]}]
	}
};

const templateReplaceSingleAlert = {
	mode: "Replace",
	health_report: {
		source: "carbide-web",
		successes: [],
		alerts: [{id: "", target: null, message: "", tenant_message: null, classifications: ["PreventAllocations"]}]
	}
};

const templateReplaceAsHealthy = {
	mode: "Replace",
	health_report: {
		source: "carbide-web",
		successes: [],
		alerts: []
	}
};

function create_el(type, attributes) {
	const el = document.createElement(type);
	Object.assign(el, attributes);
	return el;
}

function add_click_listener([id, path, body]) {
	document.getElementById(id).addEventListener("click", async e => {
		e.preventDefault();
		let base = window.location.href;
		if (base.at(base.length - 1) == '/') {
			base = base.substring(0, base.length - 1);
		}
		const response = await fetch(base + path, {
			method: "POST",
			headers: {"Content-Type": "application/json"},
			body: body(),
		});
		if (response.ok) {
			location.reload();
			return;
		}
		const text = await response.text();
		e.target.after(
			create_el("p", {
				innerText: `Failed to execute POST, status: ${response.status}, text: ${text}.`
			})
		);
	});
}

function setOverrideTextBoxToTemplate(template) {
	document.getElementById("override").value = JSON.stringify(template, null, 2);
}

document.addEventListener("DOMContentLoaded", function (event) {
	setOverrideTextBoxToTemplate(templateHealthReport);
	for (const item of [
		["submit_add", "/override/add", () => document.getElementById("override").value],
	]) {
		add_click_listener(item);
	}
	{% for override in overrides %}
	add_click_listener(["remove-override-{{ override.health_report.source }}", "/override/remove", () => JSON.stringify({source: "{{ override.health_report.source }}"})]);
	{% endfor %}
});

{% endblock %}
