{% extends "base.html" %}

{% block title %}Health Reports {{ id }}{% endblock %}

{% block content %}
<h1>{{ machine_type }} Health {{ id }}</h1>

<details>
	<summary>
		<h2 style="display: inline-block;">Add Override</h2>
	</summary>
	<p>
		<b>Instructions:</b>
		<i><ul>
			<li>Fill out the form below and press the submit button to submit a health override.</li>
			<li>The probe <b>id</b> and <b>message</b> fields need to be populated.</li>
			<li>Probe <b>target</b>s are optional.</li>
			<li>The preset buttons below allow to pre-populate the textbox for certain use-cases.</li>
		</ul></i>
	</p>
	<p>
		<b>Presets:</b>
		<ul>
			<li><input type="submit" value="Blank Example" onclick="setOverrideTextBoxToTemplate(templateHealthReport)"></li>
			<li><input type="submit" value="Internal Maintenance" onclick="setOverrideTextBoxToTemplate(templateMergeInternalMaintenance)"></li>
			<li><input type="submit" value="Out For Repair Maintenance" onclick="setOverrideTextBoxToTemplate(templateMergeOfrMaintenance)"></li>
			<li><input type="submit" value="Degraded" onclick="setOverrideTextBoxToTemplate(templateMergeDegradedMaintenance)"></li>
			<li><input type="submit" value="Suppress External Alerting Only" onclick="setOverrideTextBoxToTemplate(templateMergeSuppressExternalAlerting)"></li>
			<li><input type="submit" value="Merge: Alert which prevents allocations" onclick="setOverrideTextBoxToTemplate(templateMergeSingleAlert)"></li>
			<li><input type="submit" value="Replace: Alert which prevents allocations" onclick="setOverrideTextBoxToTemplate(templateReplaceSingleAlert)"></li>
			<li><input type="submit" value="Replace: Mark machine as healthy" onclick="setOverrideTextBoxToTemplate(templateReplaceAsHealthy)"></li>
		</ul>
	</p>
	<textarea id="override" rows="20" style="width: 100%">
	</textarea>
	<p><input type="submit" id="submit_add" value="Submit Override"></p>
</details>

<h2>Active overrides:</h2>
<table class="sortable detailsview">
<thead>
	<tr>
		<th>Source</th>
		<th>Mode</th>
		<th>Remove</th>
	</tr>
</thead>
<tbody>
	{% for override in overrides %}
	<tr>
		<td>{{ override.source }}</td>
		<td>{{ override.mode }}</td>
		<td><input type="button" id="remove-override-{{ override.source }}" value="Remove"></td>
	</tr>
	{% endfor %}
</tbody>
</table>

{% for report in reports %}
<h2>{{ report.label }}</h2>
{% match report.report %}
{% when Some with (health) %}
<h3>Alerts</h3>
<table class="sortable detailsview">
	<thead>
		<tr>
			<th>ID</th>
			<th>Target</th>
			<th>In Alert Since</th>
			<th>Message</th>
			<th>Tenant Message</th>
			<th>Classifications</th>
		</tr>
	</thead>
	<tbody>
		{% for alert in health.alerts %}
		<tr>
			<td>{{ alert.id }}</td>
			<td>{{ alert.target|option_fmt }}</td>
			<td>{{ alert.in_alert_since|option_fmt }}</td>
			<td>{{ alert.message }}</td>
			<td>{{ alert.tenant_message|option_fmt }}</td>
			<td>{{ [alert]|health_alert_classifications_fmt|safe }}</td>
		</tr>
		{% endfor %}
	</tbody>
</table>

<details>
	<summary>
		<h3 style="display: inline-block;">Successes</h3>
	</summary>
	<table class="sortable detailsview">
		<thead>
			<tr>
				<th>ID</th>
				<th>Target</th>
			</tr>
		</thead>
		<tbody>
			{% for success in health.successes %}
			<tr>
				<td>{{ success.id }}</td>
				<td>{{ success.target|option_fmt }}</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</details>
{% else %}
<h3>Missing report</h3>
{% endmatch %}
{%endfor%}

{% endblock %}

{% block script %}

const templateHealthReport = {
	mode: "Merge",
	health_report: {
		source: "carbide-web",
		successes: [{id: "", target: null}],
		alerts: [{id: "", target: null, message: "", tenant_message: null, classifications: [""]}]
	}
};

const templateMergeInternalMaintenance = {
	mode: "Merge",
	health_report: {
		source: "maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: null, message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeOfrMaintenance = {
	mode: "Merge",
	health_report: {
		source: "manual-maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: "OutForRepair", message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeDegradedMaintenance = {
	mode: "Merge",
	health_report: {
		source: "manual-maintenance",
		successes: [],
		alerts: [{id: "Maintenance", target: "Degraded", message: "", tenant_message: null, classifications: ["PreventAllocations", "SuppressExternalAlerting"]}]
	}
};

const templateMergeSuppressExternalAlerting = {
	mode: "Merge",
	health_report: {
		source: "suppress-paging",
		successes: [],
		alerts: [{id: "SuppressExternalAlerting", target: null, message: "Paging is suppressed for this Host", tenant_message: null, classifications: ["SuppressExternalAlerting"]}]
	}
};

const templateMergeSingleAlert = {
	mode: "Merge",
	health_report: {
		source: "carbide-web",
		successes: [],
		alerts: [{id: "", target: null, message: "", tenant_message: null, classifications: ["PreventAllocations"]}]
	}
};

const templateReplaceSingleAlert = {
	mode: "Replace",
	health_report: {
		source: "carbide-web",
		successes: [],
		alerts: [{id: "", target: null, message: "", tenant_message: null, classifications: ["PreventAllocations"]}]
	}
};

const templateReplaceAsHealthy = {
	mode: "Replace",
	health_report: {
		source: "carbide-web",
		successes: [],
		alerts: []
	}
};

function create_el(type, attributes) {
	const el = document.createElement(type);
	Object.assign(el, attributes);
	return el;
}

function add_click_listener([id, path, body]) {
	document.getElementById(id).addEventListener("click", async e => {
		e.preventDefault();
		let base = window.location.href;
		if (base.at(base.length - 1) == '/') {
			base = base.substring(0, base.length - 1);
		}
		const response = await fetch(base + path, {
			method: "POST",
			headers: {"Content-Type": "application/json"},
			body: body(),
		});
		if (response.ok) {
			location.reload();
			return;
		}
		const text = await response.text();
		e.target.after(
			create_el("p", {
				innerText: `Failed to execute POST, status: ${response.status}, text: ${text}.`
			})
		);
	});
}

function setOverrideTextBoxToTemplate(template) {
	document.getElementById("override").value = JSON.stringify(template, null, 2);
}

document.addEventListener("DOMContentLoaded", function (event) {
	setOverrideTextBoxToTemplate(templateHealthReport);
	for (const item of [
		["submit_add", "/override/add", () => document.getElementById("override").value],
	]) {
		add_click_listener(item);
	}
	{% for override in overrides %}
	add_click_listener(["remove-override-{{ override.source }}", "/override/remove", () => JSON.stringify({source: "{{ override.source }}"})]);
	{% endfor %}
});

{% endblock %}
