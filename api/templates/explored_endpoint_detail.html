{% extends "base.html" %}

{% block title %}Explored Endpoint {{ endpoint.address }}{% endblock %}

{% block content %}
<div id="json">
    {% if has_machine %}
    <a id="delete-link" class="disabled" href="#" onclick="return false;">Delete</a>
    {% else %}
    <a id="delete-link" href="#" onclick="if(confirm('Are you sure you want to delete this endpoint?')) { document.getElementById('delete-form').submit(); } return false;">Delete</a>
    {% endif %}
    <a id="json-link" href="">JSON</a>
</div>

<form id="delete-form" method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/delete" hidden>
</form>

<h1>Endpoint {{ endpoint.address }}</h1>
<table class="detailsview">
	<tr>
		<th>Address</th>
		<td class="action-cell">
			<div>
				{{ endpoint.address }}
			</div>
			<div>
				<form method="GET" action="/admin/redfish-browser">
					<input type="hidden" name="url" value="https://{{ endpoint.address }}/redfish/v1">
					<input type="submit" value="Redfish Browser">
				</form>
			</div>
		</td>
	</tr>
	{% match endpoint.report %}
	{% when Some with (report) %}
	<tr><th>Endpoint Type</th><td>{{ report.endpoint_type }}</td></tr>
	<tr><th>Vendor</th><td>{% match report.vendor %}{% when Some with (vendor) %} {{ vendor|capitalize }} {% else %}{% endmatch %}</td></tr>
	<tr>
		<th title="The MachineId that is calculated based on exploration data">Derived Machine ID</th>
		<td>{% match report.machine_id %}{% when Some with (machine_id) %} {{ machine_id|machine_id_link|safe }} {% else %}{% endmatch %}</td>
	</tr>
	<tr>
		<th>Last Exploration Error</th>
		{% if has_exploration_error %}
		<td class="action-cell">
			<div style="overflow: auto;">
				<pre><code class="prettyjson">{{ last_exploration_error }}</code></pre>
			</div>
			<div style="margin-left: 1rem;">
				<form id="clearlasterror_action" method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/clear-last-error">
					<input type="submit" value="Clear">
				</form>
			</div>
		</td>
		{% else %}
		<td></td>
		{% endif %}
	</tr>
	<tr>
		<th>Last Exploration Latency</th>
		<td>{% match report.last_exploration_latency %}{% when Some with (latency) %}{{ latency.seconds }}s{% else %}{% endmatch %}</td>
	</tr>
	{% else %}
	{% endmatch %}
	<tr><th>Preingestion State</th><td>{{ endpoint.preingestion_state }}</td></tr>
	<tr><th>Report Version</th><td>{{ endpoint.report_version|config_version|safe }}</td></tr>
	<tr>
		<th>Exploration Requested</th>
		<td class="action-cell">
			<div>{{ endpoint.exploration_requested }}</div>
			{% if !endpoint.exploration_requested %}
			<div>
				<form id="reexplore_action" method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/reexplore">
					<input type="hidden" name="if_version_match" value="{{ endpoint.report_version }}"/>
					<input type="submit" value="Request re-exploration">
				</form>
			</div>
			{% endif %}
		</td>
	</tr>
	<tr>
		<th>Power Actions</th>
		<td class="action-cell">
			<div>
				Last Redfish BMC Reboot: {{ endpoint.last_redfish_reboot }}
				<br>
				Last Redfish BMC Powercycle: {{ endpoint.last_redfish_powercycle }}
			</div>
			<div>
				{% set bmc_ip = endpoint.address.clone() %}
				{% include "power_control.html" %}
			</div>
		</td>
	</tr>
	<tr>
		<th>BMC Actions</th>
		<td class="action-cell">
			<div>
				Last Redfish BMC Reset: {{ endpoint.last_redfish_bmc_reset }}
				<br>
				Last IPMI BMC Reset: {{ endpoint.last_ipmitool_bmc_reset }}
			</div>
			<div>
				{% set bmc_ip = endpoint.address.clone() %}
				{% include "bmc_reset.html" %}
			</div>
		</td>
	</tr>
	<tr>
		<th>Forge Setup</th>
		<td class="action-cell">
			<div>
				<em>Current Status</em> - {{ forge_setup_status }}
			</div>
					<div>
			<form id="forge_setup" method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/forge-setup">
				<div style="display: flex; gap: 8px; align-items: center;">
					{% if is_dell_endpoint %}
					<input type="text" id="boot_interface_mac" name="boot_interface_mac" 
						   placeholder="Boot Interface MAC"
						   title="Enter a valid MAC address (e.g. 00:11:22:33:44:55)"
						   required>
					{% endif %}
					<input type="submit" value="Forge Setup" class="disabled">
				</div>
			</form>
		</div>
		</td>
	</tr>
	<tr>
		<th>Credentials</th>
		<td class="action-cell">
			<div>
				<em>Current Status</em> - {{ credentials_set }}
			</div>
			<div>
				<form id="clear_credentials" method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/clear-credentials">
					<input type="submit" class="delete-button" value="Clear Credentials">
				</form>
			</div>
		</td>
	</tr>
	<tr>
		<th>Secure Boot</th>
		<td class="action-cell">
			<div>
				<em>Current Status</em> - {{ secure_boot_status }}
			</div>
			{% include "restart_reminder.html" %}
			<div>
				<form id="disable_secure_boot" method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/disable-secure-boot" onclick="reminder(event)">
					<input type="submit" value="Disable Secure Boot">
				</form>
			</div>
		</td>
	</tr>
</table>

{% match endpoint.report %}
{% when Some with (report) %}

<h2>Systems</h2>
{% for system in report.systems %}
<table class="detailsview" style ="table-layout: fixed;">
	<tr><th>ID</th><td>{{ system.id }}</td></tr>
	<tr><th>Manufacturer</th><td>{{ system.manufacturer|option_fmt }}</td></tr>
	<tr><th>Model</th><td>{{ system.model|option_fmt }}</td></tr>
	<tr><th>Serial Number</th><td>{{ system.serial_number|option_fmt }}</td></tr>
	<tr><th>Power State</th><td>{{ "{:?}"|format(system.power_state()) }}</td></tr>
	<tr>
		<th>Boot Order</th>
		<td>
			<div style="margin-bottom: 12px;">
				<form method="POST" action="/admin/explored-endpoint/{{ endpoint.address }}/set-dpu-first-boot-order">
					<div style="display: flex; gap: 8px; align-items: center;">
						<input type="text" name="boot_interface_mac" 
							   placeholder="Boot Interface MAC"
							   title="Enter a valid MAC address (e.g. 00:11:22:33:44:55)"
							   required>
						<input type="submit" value="Set DPU First">
					</div>
				</form>
			</div>
			<div style="max-height: 300px; overflow: auto;">
				<pre><code>{{ system.boot_order|boot_order_fmt }}</code></pre>
			</div>
		</td>
	</tr>
	<tr><th>Ethernet Interfaces</th><td style="padding: 0;">
		<table>
			<thead>
				<tr>
					<th>ID</th>
					<th>MAC</th>
					<th>Enabled</th>
					<th>Description</th>
				</tr>
			</thead>
			<tbody>
			{% for iface in system.ethernet_interfaces %}
				<tr>
					<td>{{ iface.id|option_fmt }}</td>
					<td>{{ iface.mac_address|option_fmt }}</td>
					<td>{{ iface.interface_enabled|option_fmt }}</td>
					<td>{{ iface.description|option_fmt }}</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</td></tr>
	<tr>
		<th>PCIe Devices</th>
		<td style="padding: 0;">
			<table>
				<thead>
					<tr>
						<th>ID</th>
						<th>Name</th>
						<th>Manufacturer</th>
						<th>Description</th>
						<th>Firmware Version</th>
						<th>GPU Vendor</th>
						<th>Part Number</th>
						<th>Serial Number</th>
					</tr>
				</thead>
				<tbody>
					{% for pci in system.pcie_devices %}
					<tr>
						<td>{{ pci.id|option_fmt }}</td>
						<td>{{ pci.name|option_fmt }}</td>
						<td>{{ pci.manufacturer|option_fmt }}</td>
						<td>{{ pci.description|option_fmt }}</td>
						<td>{{ pci.firmware_version|option_fmt }}</td>
						<td>{{ pci.gpu_vendor|option_fmt }}</td>
						<td>{{ pci.part_number|option_fmt }}</td>
						<td>{{ pci.serial_number|option_fmt }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</td>
	</tr>
</table>
{% endfor %}

<h2>Managers</h2>
{% for manager in report.managers %}
<table class="detailsview">
	<tr><th>ID</th><td>{{ manager.id }}</td></tr>
	<tr><th>Ethernet Interfaces</th><td style="padding: 0;">
		<table>
			<thead>
				<tr>
					<th>ID</th>
					<th>MAC</th>
					<th>Enabled</th>
					<th>Description</th>
				</tr>
			</thead>
			<tbody>
			{% for iface in manager.ethernet_interfaces %}
				<tr>
					<td>{{ iface.id|option_fmt }}</td>
					<td>{{ iface.mac_address|option_fmt }}</td>
					<td>{{ iface.interface_enabled|option_fmt }}</td>
					<td>{{ iface.description|option_fmt }}</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</td></tr>
</table>
{% endfor %}

<h2>Chassis</h2>
{% for chassis in report.chassis %}
<table class="detailsview">
	<tr><th>ID</th><td>{{ chassis.id }}</td></tr>
	<tr><th>Manufacturer</th><td>{{ chassis.manufacturer|option_fmt }}</td></tr>
	<tr><th>Model</th><td>{{ chassis.model|option_fmt }}</td></tr>
	<tr><th>Serial Number</th><td>{{ chassis.serial_number|option_fmt }}</td></tr>
	<tr><th>Part Number</th><td>{{ chassis.part_number|option_fmt }}</td></tr>
	<tr><th>Network Adapters</th><td style="padding: 0;">
		<table>
			<thead>
				<tr>
					<th>ID</th>
					<th>Manufacturer</th>
					<th>Model</th>
					<th>Part Number</th>
					<th>Serial Number</th>
				</tr>
			</thead>
			<tbody>
			{% for iface in chassis.network_adapters %}
				<tr>
					<td>{{ iface.id }}</td>
					<td>{{ iface.manufacturer|option_fmt }}</td>
					<td>{{ iface.model|option_fmt }}</td>
					<td>{{ iface.part_number|option_fmt }}</td>
					<td>{{ iface.serial_number|option_fmt }}</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</td></tr>
</table>
{% endfor %}

<h2>Services</h2>
{% for service in report.service %}
<table class="detailsview">
	<tr><th>ID</th><td>{{ service.id }}</td></tr>
	<tr><th>Inventory</th><td style="padding: 0;">
		<table>
			<thead>
				<tr>
					<th>ID</th>
					<th>Version</th>
					<th>Release Date</th>
					<th>Description</th>
				</tr>
			</thead>
			<tbody>
			{% for item in service.inventories %}
				<tr>
					<td>{{ item.id }}</td>
					<td>{{ item.version|option_fmt }}</td>
					<td>{{ item.release_date|option_fmt }}</td>
					<td>{{ item.description|option_fmt }}</td>
				</tr>
			{% endfor %}
			</tbody>
		</table>
	</td></tr>
</table>
{% endfor %}

{% else %}
{% endmatch %}

{% endblock %}
