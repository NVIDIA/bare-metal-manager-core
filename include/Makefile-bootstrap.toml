[tasks.build-bootstrap-forge-docker]
category = "Bootstrap Forge"
workspace = false
script = '''
#!/usr/bin/env bash
source include/envrc-docker-compose
echo $DATABASE_URL
vpc=$(grpcurl -d '{"name":"test_vpc"}' -plaintext 127.0.0.1:1079 forge.Forge/CreateVpc | jq ".id.value" | tr -d '"')
domain=$(grpcurl -d '{"name":"forge.local"}' -plaintext 127.0.0.1:1079 forge.Forge/CreateDomain | jq ".id.value" | tr -d '"')
segment=$(grpcurl -d "{\"name\":\"test\", \"mtu\": 1490, \"prefixes\":[{\"prefix\":\"172.20.0.0/24\",\"gateway\":\"172.20.0.1\",\"reserve_first\":30}], \"subdomain_id\": { \"value\":\"$domain\"}, \"vpc_id\": { \"value\": \"$vpc\"}}" -plaintext 127.0.0.1:1079 forge.Forge/CreateNetworkSegment | jq ".id.value" | tr -d '"')

RELAY_ADDRESS=$(jq '.relay_address' $REPO_ROOT/dev/grpc-test-data/host_dhcp_discovery.json | tr -d '"')

echo Relay address: $RELAY_ADDRESS
echo Segment: $segment

$REPO_ROOT/dev/grpc-test-data/discover_dpu.sh
psql -t -c "UPDATE vpc_resource_leafs SET loopback_ip_address='$RELAY_ADDRESS' WHERE loopback_ip_address IS NULL;"

echo "Waiting for the network segment to become ready"
echo "If this step fails, run /dev/grpc-test-data/discover_host.sh manually"
while [ $(grpcurl -plaintext 127.0.0.1:1079 forge.Forge/FindNetworkSegments | jq ".networkSegments[0].state") != '"READY"' ]; do
	echo -n '.'
	sleep 1
done
echo ''

$REPO_ROOT/dev/grpc-test-data/discover_host.sh
'''
cwd="${REPO_ROOT}"

[tasks.build-bootstrap-forge-kube]
category = "Bootstrap Forge"
workspace = false
script = '''
vpc=$(grpcurl -d '{"name":"test_vpc"}' -plaintext 127.0.0.1:80 forge.Forge/CreateVpc | jq ".id.value" | tr -d '"')
domain=$(grpcurl -d '{"name":"forge.local"}' -plaintext 127.0.0.1:80 forge.Forge/CreateDomain | jq ".id.value" | tr -d '"')
grpcurl -d "{\"name\":\"test\", \"mtu\": 1490, \"prefixes\":[{\"prefix\":\"172.20.0.0/24\",\"gateway\":\"172.20.0.1\",\"reserve_first\":22}, {\"prefix\":\"::1/128\", \"reserve_first\":0}], \"subdomain_id\": { \"value\":\"$domain\"}, \"vpc_id\": { \"value\": \"$vpc\"}}" -plaintext 127.0.0.1:80 forge.Forge/CreateNetworkSegment
'''
cwd="${REPO_ROOT}"
