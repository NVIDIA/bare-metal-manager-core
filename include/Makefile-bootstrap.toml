[tasks.build-bootstrap-forge-docker]
category = "Bootstrap Forge"
workspace = false
script = '''
vpc=$(grpcurl -d '{"name":"test_vpc"}' -plaintext 127.0.0.1:1079 forge.v0.Forge/CreateVpc | jq ".id.value" | tr -d '"')
domain=$(grpcurl -d '{"name":"forge.local"}' -plaintext 127.0.0.1:1079 forge.v0.Forge/CreateDomain | jq ".id.value" | tr -d '"')
segment=$(grpcurl -d "{\"name\":\"test\", \"mtu\": 1490, \"prefixes\":[{\"prefix\":\"172.20.0.0/24\",\"gateway\":\"172.20.0.1\",\"reserve_first\":30}], \"subdomain_id\": { \"value\":\"$domain\"}, \"vpc_id\": { \"value\": \"$vpc\"}}" -plaintext 127.0.0.1:1079 forge.v0.Forge/CreateNetworkSegment | jq ".id.value" | tr -d '"')
machine=$(PGPASSWORD=notforprod psql -h localhost -U carbide_development -d carbide_development -t -c 'INSERT INTO machines VALUES(DEFAULT) RETURNING id;' | head -1 | tr -d ' ')
interface=$(PGPASSWORD=notforprod psql -h localhost -U carbide_development -d carbide_development -t -c "INSERT INTO machine_interfaces (attached_dpu_machine_id,machine_id,segment_id,mac_address,domain_id,hostname,primary_interface) VALUES (NULL, '${machine}', '${segment}', 'de:af:de:ad:be:ef','${domain}','myhost',true) RETURNING id;" | head -1 | tr -d ' ')
PGPASSWORD=notforprod psql -h localhost -U carbide_development -d carbide_development -t -c "INSERT INTO machine_interface_addresses (interface_id, address) VALUES ('$interface', '172.20.0.20');"
PGPASSWORD=notforprod psql -h localhost -U carbide_development -d carbide_development -t -c "INSERT INTO machine_interface_addresses (interface_id, address) VALUES ('$interface', '::1/128');"
'''
cwd="${REPO_ROOT}"

[tasks.build-bootstrap-forge-kube]
category = "Bootstrap Forge"
workspace = false
script = '''
vpc=$(grpcurl -d '{"name":"test_vpc"}' -plaintext 127.0.0.1:80 forge.v0.Forge/CreateVpc | jq ".id.value" | tr -d '"')
domain=$(grpcurl -d '{"name":"forge.local"}' -plaintext 127.0.0.1:80 forge.v0.Forge/CreateDomain | jq ".id.value" | tr -d '"')
grpcurl -d "{\"name\":\"test\", \"mtu\": 1490, \"prefixes\":[{\"prefix\":\"172.20.0.0/24\",\"gateway\":\"172.20.0.1\",\"reserve_first\":22}, {\"prefix\":\"::1/128\", \"reserve_first\":0}], \"subdomain_id\": { \"value\":\"$domain\"}, \"vpc_id\": { \"value\": \"$vpc\"}}" -plaintext 127.0.0.1:80 forge.v0.Forge/CreateNetworkSegment
'''
cwd="${REPO_ROOT}"
