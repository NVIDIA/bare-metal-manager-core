[tasks.build-bootstrap-forge-kube]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "kube" }
run_task = { name = [ "build-bootstrap-forge-base",
    "build-bootstrap-forge-dpu-discovery",
    "build-bootstrap-forge-host-discovery" ] }

[tasks.build-bootstrap-forge-docker]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "docker" }
run_task = { name = [
    "build-bootstrap-forge-base",
    "build-bootstrap-forge-dpu-discovery",
    "build-bootstrap-forge-host-discovery" ] }

[tasks.build-bootstrap-forge-base-kube]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "kube" }
run_task = "build-bootstrap-forge-base"

[tasks.build-bootstrap-forge-base-docker]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "docker" }
run_task = "build-bootstrap-forge-base"

[tasks.build-bootstrap-forge-dpu-discovery-kube]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "kube" }
run_task = "build-bootstrap-forge-dpu-discovery"

[tasks.build-bootstrap-forge-dpu-discovery-docker]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "docker" }
run_task = "build-bootstrap-forge-dpu-discovery"

[tasks.build-bootstrap-forge-vmhost-init-kube]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "kube" }
run_task = { name=["build-bootstrap-forge-base",
    "build-bootstrap-forge-dpu-discovery",
    "build-bootstrap-forge-vmhost-init"]}

[tasks.build-bootstrap-forge-vmhost-init-docker]
category = "Bootstrap"
workspace = false
env = { "FORGE_BOOTSTRAP_KIND" = "docker" }
run_task = { name=["build-bootstrap-forge-base",
    "build-bootstrap-forge-dpu-discovery",
    "build-bootstrap-forge-vmhost-init"]}

[tasks.build-bootstrap-forge-base]
category = "Bootstrap"
workspace = false
script = '''
#!/usr/bin/env bash
set -e

echo "repo root: ${REPO_ROOT}"
DATA_PATH=${REPO_ROOT}/dev/${FORGE_BOOTSTRAP_KIND}-env
echo using data path ${DATA_PATH}
source ${DATA_PATH}/envrc
CONTAINER_DATA_PATH=${CONTAINER_REPO_ROOT:-${REPO_ROOT}}/dev/${FORGE_BOOTSTRAP_KIND}-env
echo using container data path ${CONTAINER_DATA_PATH}

SEGMENT_COUNT=$(${REPO_ROOT}/dev/bin/psql.sh 'select count(*) from network_segments;' | tr -d '\n\r ')
echo "segment count: ${SEGMENT_COUNT}"

if [ 0 -eq ${SEGMENT_COUNT} ]
then
	# The domain was created by carbide-api on startup. Find it's ID.
	domain=$(grpcurl -d '{"name":"forge.local"}' -insecure $API_SERVER_HOST:$API_SERVER_PORT forge.Forge/FindDomain | jq ".domains[0].id.value" | tr -d '"')
	vpc=$(grpcurl -d '{"name":"test_vpc"}' -insecure $API_SERVER_HOST:$API_SERVER_PORT forge.Forge/CreateVpc | jq ".id.value" | tr -d '"')
	segment=$(grpcurl -d "{\"name\":\"test\", \"mtu\": 1490, \"segment_type\":1, \"prefixes\":[{\"prefix\":\"${NET_PREFIX}\",\"gateway\":\"${NET_GATEWAY}\",\"reserve_first\":100}], \"subdomain_id\": { \"value\":\"$domain\"}, \"vpc_id\": { \"value\": \"$vpc\"}}" -insecure $API_SERVER_HOST:$API_SERVER_PORT forge.Forge/CreateNetworkSegment | jq ".id.value" | tr -d '"')

	echo "vpc: $vpc, domain: $domain, segment: $segment"

	echo "Waiting for the network segment to become ready"
	while [ $(grpcurl -d "{\"id\": {\"value\": \"$segment\"}}" -insecure $API_SERVER_HOST:$API_SERVER_PORT forge.Forge/FindNetworkSegments | jq ".networkSegments[0].state") != '"READY"' ]; do
		echo -n '.'
		sleep 1
	done
else
	echo "${SEGMENT_COUNT} network segments exist. Skipping."
fi
echo ''
'''

[tasks.build-bootstrap-forge-dpu-discovery]
category = "Bootstrap"
workspace = false
script = '''
#!/usr/bin/env bash
set -e

DATA_PATH=${REPO_ROOT}/dev/${FORGE_BOOTSTRAP_KIND}-env
echo using data path ${DATA_PATH}
source ${DATA_PATH}/envrc

DPU_COUNT=$(${REPO_ROOT}/dev/bin/psql.sh "select count(id) from machines where id like 'fm100d%';" |& tr -d ' \r\n')

if [ $DPU_COUNT -eq 0 ]
then
  RELAY_ADDRESS=$(jq '.relay_address' $DATA_PATH/host_dhcp_discovery.json | tr -d '"')
  echo Relay address: $RELAY_ADDRESS

  ${REPO_ROOT}/dev/bin/discover_dpu.sh ${DATA_PATH}
else
  echo "$DPU_COUNT DPUs exist. skipping"
fi
'''
cwd="${REPO_ROOT}"

[tasks.build-bootstrap-forge-vmhost-init]
category = "Bootstrap"
workspace = false
script = '''
#!/usr/bin/env bash
set -e

DATA_PATH=${REPO_ROOT}/dev/${FORGE_BOOTSTRAP_KIND}-env
echo "using data path ${DATA_PATH}/envrc"
source ${DATA_PATH}/envrc

${REPO_ROOT}/dev/bin/discover_host.sh $API_SERVER_HOST $API_SERVER_PORT ${DATA_PATH} dhcp-only
'''
cwd="${REPO_ROOT}"

[tasks.build-bootstrap-forge-host-discovery]
category = "Bootstrap"
workspace = false
script = '''
#!/usr/bin/env bash
set -e

DATA_PATH=${REPO_ROOT}/dev/${FORGE_BOOTSTRAP_KIND}-env
echo using data path ${DATA_PATH}
source ${DATA_PATH}/envrc

${REPO_ROOT}/dev/bin/discover_host.sh $API_SERVER_HOST $API_SERVER_PORT ${DATA_PATH} full
'''

[tasks.test-instance-forge-docker]
workspace = false
script = '''
#!/usr/bin/env bash

source ${REPO_ROOT}/dev/docker-env/envrc
echo "In case you don't want to delete instance for further testing, call script 'dev/bin/instance_handling.sh create' and 'dev/bin/instance_handling.sh delete'"
${REPO_ROOT}/dev/bin/instance_handling.sh test ${API_SERVER_HOST} ${API_SERVER_PORT}
'''
cwd="${REPO_ROOT}"

[tasks.test-instance-forge-kube]
workspace = false
script = '''
#!/usr/bin/env bash

source ${REPO_ROOT}/dev/kube-env/envrc
echo "In case you don't want to delete instance for further testing, call script 'dev/bin/instance_handling.sh create' and 'dev/bin/instance_handling.sh delete'"
${REPO_ROOT}/dev/bin/instance_handling.sh test ${API_SERVER_HOST} ${API_SERVER_PORT}
'''

